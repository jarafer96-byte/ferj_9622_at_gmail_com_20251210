<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Vista previa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Vista previa para redes sociales -->
  <meta property="og:title" content="">
  <meta property="og:description" content="">
  <meta property="og:image" content="">
  <meta property="og:image:type" content="image/jpeg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <!-- Google Fonts disponibles -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Playfair+Display&family=Fira+Code&family=Raleway&family=Quicksand&family=Pacifico&family=Source+Serif+4&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Favicon est√°ndar -->
  <link rel="icon" type="image/png" sizes="32x32" href="/static/img/favicon32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/img/favicon16.png">

  <!-- Para iOS/Android -->
  <link rel="apple-touch-icon" sizes="180x180" href="/static/img/faviconmovil.png">

  
  
    
  

<style>
body {
  font-family: 'Raleway', sans-serif;
  
  background-image: url("/static/img/mini_1_jfjf8.jpeg");
  
  background-size: cover; background-repeat: no-repeat; background-attachment: fixed; background-position: center; padding-top: 70px;
}
/* üì± Para m√≥viles */
@media (max-width: 768px) {
  body {
    background-image: url("/static/img/fondo-movil.jpg");
    background-size: cover;
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-position: center;
  }
}
/* üì± En pantallas chicas (celulares) */
@media (max-width: 768px) {
  body {
    background-size: cover; /* ocupa toda la pantalla */
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-position: center;
  }
}
/* üì± Solo en pantallas chicas (ej: m√≥viles) */
@media (max-width: 768px) {
  .barra-navegacion {
    border: 1px solid #000000f5; /* borde solo en m√≥vil */
  }
}  
h1, h2, h3, .btn, .card { font-family: 'Raleway', sans-serif; }

body::before { content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: -1; }

.fade-reorder { opacity: 0; transform: scale(0.95); transition: opacity 0.3s ease, transform 0.3s ease; }

.fade-reorder.show { opacity: 1; transform: scale(1); }

.show { opacity: 1; transform: scale(1); transition: opacity 0.3s ease, transform 0.3s ease; }

.fondo-animado { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -2; background: radial-gradient(circle at 20% 30%, rgba(255,255,255,0.08), transparent 40%), radial-gradient(circle at 80% 70%, rgba(255,255,255,0.06), transparent 40%); animation: moverFondo 40s ease-in-out infinite; background-size: 200% 200%; pointer-events: none; }

html { scroll-behavior: auto; }

.card { transition: transform 0.3s ease, box-shadow 0.3s ease; border-radius: 12px; overflow: hidden; will-change: transform, box-shadow; padding: 12px; }

.card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }

.modo-oscuro .card:hover { box-shadow: 0 8px 20px rgba(255,255,255,0.2); }

.modo-claro .card:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.3); }

.card-img-top { width: 100%; max-width: 300px; height: auto; display: block; margin-left: auto; margin-right: auto; }

.card-body { padding: 10px; }

.card-title { font-size: 1rem; }

.card-text { font-size: 0.9rem; }

.modo-claro .card { background-color: #fff; color: #333; border: none; }

.modo-oscuro .card { background-color: rgba(0,0,0,0.6); color: white; border: 1px solid rgba(255,255,255,0.2); }

.color-principal { color: inherit; /* o un color fijo, ej. #ff6f61 */ }

.bg-principal { background-color: transparent; /* o un color fijo */ }

.modo-oscuro { color: white; }

.modo-claro { color: #333; }

.barra-navegacion { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(6px); display: flex; justify-content: center; gap: 16px; padding: 12px 20px; box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1); }

.barra-navegacion button { font-family: 'Raleway', sans-serif; font-weight: 600; font-size: 16px; padding: 10px 20px; border-radius: 30px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.05); color: white; box-shadow: 0 0 6px rgba(255, 255, 255, 0.2); transition: all 0.3s ease; }

/* Animaciones */
@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

@keyframes moverFondo { 0% { background-position: 0% 0%; } 50% { background-position: 100% 100%; } 100% { background-position: 0% 0%; } }

.barra-navegacion button:hover { background: rgba(255, 255, 255, 0.15); transform: scale(1.05); box-shadow: 0 0 8px rgba(255, 255, 255, 0.3); }

.barra-wrapper { z-index: 1000; }
  
.panel-grupos::-webkit-scrollbar {
  display: none;
}
.panel-subcategorias::-webkit-scrollbar {
  display: none;
} 
.panel-grupos { position: fixed; scrollbar-width: none; -webkit-overflow-scrolling: touch; overflow-y: hidden; overflow-x: auto; white-space: nowrap; cursor: grab; cursor: -webkit-grab; border: 1px solid #000000f5; max-height: 50vh; overflow-y: auto; left: 0; right: 0; z-index: 906; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(6px); padding: 1px 0; text-align: center; box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1); }

.panel-grupos button { font-family: 'Raleway', sans-serif; font-weight: 600; margin: 6px; padding: 2px 8px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 30px; background: rgba(255, 255, 255, 0.05); color: white; box-shadow: 0 0 6px rgba(255, 255, 255, 0.2); cursor: pointer; transition: all 0.3s ease; }

.panel-grupos button:hover { background: rgba(255, 255, 255, 0.15); transform: scale(1.05); box-shadow: 0 0 8px rgba(255, 255, 255, 0.3); }

.oculta { display: none !important; }

.logo { height: 40vw; max-height: 380px; filter: brightness(1.5) contrast(1.2) drop-shadow(0 0 14px white); transition: filter 0.3s ease; animation: pulsoLogo 4s ease-in-out infinite; }

@keyframes pulsoLogo { 0%, 100% { filter: brightness(1.5) contrast(1.2) drop-shadow(0 0 14px none); } 50% { filter: brightness(1.8) contrast(1.3) drop-shadow(0 0 20px none); } }

.descripcion-emprendimiento { background-color: rgba(0, 0, 0, 0.5); color: white; padding: 20px; border-radius: 10px; display: inline-block; max-width: 800px; white-space: pre-line; text-align: center; text-indent: 20px; font-size: 16px; line-height: 1.6; box-shadow: 0 0 6px rgba(255,255,255,0.3); }

.btn-grupo { position: relative; padding: 8px 16px; margin: 5px; border-radius: 20px; font-weight: bold; background-color: rgba(0, 0, 0, 0.5); color: white; border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 0 6px rgba(255,255,255,0.3); transition: all 0.3s ease; overflow: hidden; }

.modo-claro .btn-grupo { background-color: transparent; color: white; border: none; }

.modo-oscuro .btn-grupo { background-color: rgba(255, 255, 255, 0.05); color: white; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 0 4px rgba(255,255,255,0.1); }

.btn-grupo::before { content: ""; position: absolute; inset: 0; border-radius: 20px; z-index: -1; }

.modo-claro .btn-grupo::before { background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.08), transparent 70%); }

.modo-oscuro .btn-grupo::before { background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05), transparent 70%); }

.btn-grupo:hover { background-color: #fff; color: #333; transform: scale(1.05); box-shadow: 0 0 8px none; }

.btn-grupo.active { box-shadow: none; }

.btn-whatsapp { background-color: #25D366; border: none; padding: 8px 16px; color: white; border-radius: 5px; font-size: 14px; }

.btn-volver-arriba { background-color: white; color: black; border: none; font-size: 20px; box-shadow: 0 0 6px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; -webkit-tap-highlight-color: transparent; }

.btn-volver-arriba:hover { background-color: #f0f0f0; transform: scale(1.1); }

.btn-volver-arriba:focus, .btn-volver-arriba:active, .btn-volver-arriba:visited { outline: none; box-shadow: none; background-color: white; color: black; }

.grupo-section.active { display: block !important; }

/* Bloque de grupo */
.grupo-section { display: block; min-height: 100vh; margin: 20px 0; padding: 15px; border: 2px solid #333; border-radius: 6px; background: #fafafa; }

/* T√≠tulo de grupo */
.grupo-section > h3 { margin: 0 0 10px; font-size: 1.4rem; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 5px; }

/* Bloque de subgrupo dentro del grupo */
.subgrupo-bloque { margin: 15px 0; padding: 10px; border: 1px dashed #666; border-radius: 4px; background: #fff; }

/* T√≠tulo de subgrupo */
.subgrupo-bloque > h4 { margin: 0 0 8px; font-size: 1.1rem; font-weight: 600; color: #444; border-bottom: 1px dotted #aaa; padding-bottom: 4px; }

.subgrupo-bloque .card-producto { margin-bottom: 12px; }

.social-icons { margin-top: 40px; display: flex; justify-content: center; gap: 20px; }

.social-icons img { width: 40px; transition: transform 0.3s ease; filter: drop-shadow(0 0 3px white); }

.social-icons img:hover { transform: scale(1.1); filter: drop-shadow(0 0 0 transparent); }

.bloque-ubicacion { background-color: rgba(0, 0, 0, 0.5); color: white; padding: 12px 16px; border-radius: 10px; text-align: center; max-width: 600px; margin: 20px auto 0; box-shadow: 0 0 6px rgba(255,255,255,0.3); }

/* Contenedor flotante del carrito */
#carrito {
  position: fixed;
  bottom: 80px;
  right: 20px;
  padding: 15px;
  border-radius: 10px;
  width: 320px;              /* un poco m√°s ancho para el carrusel */
  z-index: 999;
  display: none;             /* oculto por defecto */
}

/* Modo oscuro */
.modo-oscuro #carrito {
  background-color: rgba(0,0,0,0.85);
  color: white;
  border: 1px solid white;
  box-shadow: 0 0 10px white;
}

/* Modo claro */
.modo-claro #carrito {
  background-color: #fff;
  color: #333;
  border: 1px solid #ccc;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
}

/* Bot√≥n flotante para abrir/cerrar */
#toggleCarrito {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
  padding: 10px 14px;
  border-radius: 50px;
  font-weight: bold;
  box-shadow: 0 0 5px white;
  cursor: pointer;
}

.modo-oscuro #toggleCarrito {
  background-color: transparent;
  color: black;
  border: none;
}

.modo-claro #toggleCarrito {
  background-color: transparent;
  color: white;
  border: none;
}

/* Carrusel interno */
#carritoCarousel .carousel-item {
  padding: 10px;
}

#carritoCarousel h3 {
  font-size: 1.2rem;
  margin-bottom: 10px;
}
/* A√±adir al bloque de estilos existente */
.modal-talles-stock .row {
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
}

.modal-talles-stock input[type="text"],
.modal-talles-stock input[type="number"] {
  font-size: 14px;
}

/* Badge para productos con stock por talle */
.badge-stock-talle {
  font-size: 0.8em;
  padding: 3px 8px;
  background: linear-gradient(45deg, #17a2b8, #20c997);
  color: white;
}

/* Input para editar stock en l√≠nea */
input.stock-edit {
  width: 70px;
  display: inline-block;
  margin: 0 5px;
}
#carritoCarousel ul {
  padding-left: 0;
  list-style: none;
  margin-bottom: 10px;
}

#carritoCarousel li {
  font-size: 0.9rem;
  margin-bottom: 4px;
}

/* Botones dentro del carrusel */
#carritoCarousel .btn {
  font-size: 0.9rem;
  padding: 6px 10px;
}
.panel-grupos,
.panel-subcategorias {
  scroll-behavior: smooth; /* hace que el scroll sea animado */
}
.panel-grupos,
.panel-subcategorias {
  cursor: default; /* cursor normal por defecto */
}

.panel-grupos:hover,
.panel-subcategorias:hover {
  cursor: ew-resize; /* flechas izquierda-derecha al pasar el mouse */
}
.panel-subcategorias { position: fixed; scrollbar-width: none; -webkit-overflow-scrolling: touch; overflow-y: hidden; overflow-x: auto; white-space: nowrap; cursor: grab; cursor: -webkit-grab; border: 1px solid #000000f5; max-height: 50vh; overflow-y: auto; left: 0; right: 0; z-index: 908; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(6px); padding: 1px 0; text-align: center; box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }

.panel-subcategorias button { font-family: 'Raleway', sans-serif; font-weight: 600; margin: 6px; padding: 1px 8px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 30px; background: rgba(255, 255, 255, 0.05); color: white; box-shadow: 0 0 6px rgba(255, 255, 255, 0.2); cursor: pointer; transition: all 0.3s ease; }

.panel-subcategorias button:hover { background: rgba(255, 255, 255, 0.15); transform: scale(1.05); }

@media (min-width: 1024px) { .logo { width: 150px; height: 150px; max-height: none; } }

.barra-navegacion { padding: 8px 10px; gap: 8px; }

.barra-navegacion button { font-size: 14px; padding: 8px 15px; }

.panel-grupos { padding: 1px 0; max-height: 50vh; overflow-y: hidden; }

.panel-grupos button { font-size: 13px; padding: 1px 6px; border-radius: 8px; }

.panel-subcategorias { padding: 1px 0; max-height: 50vh; overflow-y: hidden; }

.panel-subcategorias button { font-size: 13px; padding: 1px 6px; border-radius: 8px; }

.productos-container { margin-top: 30px; }
.logo-wrapper {
  margin-top: 20px;   /* espacio fijo arriba */
  margin-bottom: 20px;/* espacio fijo abajo */
}
@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

@keyframes moverFondo { 0% { background-position: 0% 0%; } 50% { background-position: 100% 100%; } 100% { background-position: 0% 0%; } }
/* Imagen dentro de la card */
#previewFoto {
  width: 300px;
  height: 180px;
  object-fit: contain; /* o cover seg√∫n prefieras */
  cursor: pointer;     /* indica que se puede hacer click */
  transition: transform 0.3s ease;
}
#previewFoto:hover {
  transform: scale(1.05); /* peque√±o zoom al pasar el mouse */
}

/* Modal */
#imgModal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.8);
  display: none; /* oculto por defecto */
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.3s ease;
  opacity: 0;
}
#imgModal.show {
  display: flex;
  opacity: 1;
}

/* Imagen dentro del modal */
#imgModal img {
  max-width: 95%;
  max-height: 95%;
  border-radius: 8px;
  transform: scale(0.8);
  transition: transform 0.3s ease, opacity 0.3s ease;
  opacity: 0;
}
#imgModal.show img {
  transform: scale(1.5); /* zoom suave */
  opacity: 1;
}

/* Bot√≥n de cierre */
#imgModal .close {
  position: absolute;
  top: 20px; right: 30px;
  font-size: 40px;
  color: white;
  cursor: pointer;
  transition: opacity 0.2s ease;
}
#imgModal .close:hover {
  opacity: 0.7;
}
/* Aviso flotante de stock actualizado */
#avisoStock {
  display: none;
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  padding: 10px 20px;
  border-radius: 5px;
  background-color: #17a2b8;
  color: white;
  font-weight: bold;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}  
/* A√±adir al final del bloque de estilos */

/* Indicador de colores en las cards */
.color-indicator {
  display: inline-block;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  margin-right: 5px;
  border: 1px solid #ccc;
  vertical-align: middle;
}

/* Badge para productos con variantes */
.badge-variantes {
  font-size: 0.8em;
  padding: 3px 8px;
  background: linear-gradient(45deg, #6f42c1, #20c997);
  color: white;
}

/* Modal de variantes */
.modal-variantes table {
  font-size: 0.9em;
}

.modal-variantes th {
  background-color: #f8f9fa;
}

/* Selector de color mejorado */
.color-selector {
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
  margin-top: 5px;
}

.color-option {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid transparent;
  transition: border 0.2s;
}

.color-option.selected {
  border: 2px solid #000;
  box-shadow: 0 0 5px rgba(0,0,0,0.5);
}
  
</style>
</head>
<body class="container py-5 modo-oscuro">
  

  <div class="text-center my-5 logo-wrapper">
    <img src="/static/img/Copilot_20251101_125947.png"
         alt="Logo"
         class="img-fluid logo mx-auto d-block"
         loading="lazy">
  </div>



  <div class="text-center mb-4">
    <div class="descripcion-emprendimiento">
       sad
    </div>
  </div>
 
  
<div id="configurarMP" class="d-none" style="margin-top:10px;">
  <button class="btn btn-sm btn-primary" onclick="abrirConfigMercadoPago()">
    ‚öôÔ∏è Configurar Mercado Pago
  </button>
</div>
  
  <div class="text-center mt-5 mb-1">
    <select id="ordenPrecio" class="form-select w-auto d-inline-block">
      <option value="asc">Precio: Menor a mayor</option>
      <option value="desc">Precio: Mayor a menor</option>
    </select>
  </div>
  
  <div class="barra-wrapper">
    <nav class="barra-navegacion">
      <button id="btnProductos" onclick="mostrarTodos()">Productos</button>
      <button id="btnContacto" onclick="irAContacto()">Contacto</button>
    </nav>

    <!-- Panel de grupos: ahora vac√≠o, se llena con JS -->
    <div id="panelGrupos" class="panel-grupos oculta">
      <!-- Los botones de grupo se generan din√°micamente desde la API -->
    </div>
  </div>

  <!-- Panel de subcategor√≠as: tambi√©n se llena con JS -->
  <div id="panelSubcategorias" class="panel-subcategorias oculta"></div>
  <!-- Contenedor principal de productos -->
<div id="productos" class="row productos-container"></div>


  <button id="volverArriba" class="btn btn-volver-arriba" 
          style="position: fixed; bottom: 20px; left: 20px; display: none; z-index: 1000;">
    ‚Üë
  </button>

<div id="contenedor-grupos"></div>
  
<div id="adminCard" class="card producto-card admin-card d-none">
  <div class="card-body">
    <!-- Foto -->
    <img id="previewFoto" src="" alt="Sin foto" class="d-none w-100 mb-2">
    <input type="file" id="inputFoto" accept="image/*" class="form-control mb-2">
    <button id="btnQuitarFoto" type="button" class="btn btn-danger mb-2 d-none">‚ùå Quitar foto</button>
    
    <!-- Datos -->
    <input type="text" id="nombreProd" placeholder="Nombre producto *" class="form-control mb-2">
    <input type="number" id="precioProd" placeholder="Precio *" class="form-control mb-2">
    
    <!-- üî• NUEVO: Campo de descripci√≥n -->
    <textarea id="descripcionProd" placeholder="Descripci√≥n del producto (opcional)" 
              class="form-control mb-2" rows="3"></textarea>
    
    <!-- Talles -->
    <input type="text" id="tallesProd" placeholder="Talles (S,M,L)" class="form-control mb-2">
    
    <!-- Stock (simplificado) -->
    <div id="stockSimple" class="mb-2">
      <input type="number" id="stockGeneral" placeholder="Stock inicial" min="0" value="0" class="form-control">
    </div>
    
    <!-- Stock por talle (aparece solo si hay talles) -->
    <div id="stockPorTalleContainer" class="mb-2" style="display:none;">
      <label class="form-label">Stock por talle (ej: S:5, M:3, L:2)</label>
      <input type="text" id="stockPorTalle" placeholder="S:5, M:3, L:2" class="form-control">
      <small class="text-muted">Separar por comas: talle:cantidad</small>
    </div>

    <!-- Grupo/Subgrupo -->
    <input type="text" id="grupoProd" placeholder="Grupo *" class="form-control mb-2">
    <input type="text" id="subgrupoProd" placeholder="Subgrupo *" class="form-control mb-2">

    <!-- Confirmar -->
    <button id="btnConfirmarProd" class="btn btn-success">‚úÖ Confirmar</button>
    
    <!-- üî• NUEVO: Bot√≥n para cancelar edici√≥n -->
    <button id="btnCancelarEdicion" class="btn btn-secondary mt-2" onclick="resetearFormularioAdmin()" style="display:none;">
      ‚ùå Cancelar edici√≥n
    </button>
  </div>
</div>
  
<div id="paginacion" class="text-center mt-3"></div>

<div class="text-center mt-5">
  <a href="/descargar" class="btn btn-primary px-5">
    Descargar sitio
  </a>
</div>

<div class="social-icons">
  
    <a href="https://www.facebook.com/laanonimaoficial/?locale=es_LA" target="_blank">
      <img src="/static/img/facebook.png" alt="Facebook" loading="lazy">
    </a>
  
  
    <a href="https://www.instagram.com/laanonimaoficial/" target="_blank">
      <img src="/static/img/instagram.png" alt="Instagram" loading="lazy">
    </a>
  
  
    <a href="https://wa.me/5492975158178" target="_blank">
      <img src="/static/img/whatsapp.png" alt="WhatsApp" loading="lazy">
    </a>
  
</div>


  <div id="ubicacion" class="bloque-ubicacion text-center mt-4" style="margin-bottom:120px;">
    <p style="margin-bottom: 6px;">
      üìç Corrientes 731 (Local 4)
    </p>
    
      <a href="https://maps.app.goo.gl/4UEnkZFeidM2cZhc8" target="_blank" style="text-decoration: none;">
        <span style="margin-right: 6px;">‚ûú</span>
        <img src="/static/img/map.png" alt="Ver en Google Maps" style="width: 30px;" loading="lazy">
      </a>
    
  </div>

  
<form onsubmit="loginAdmin(event)" class="mt-5 text-center">
  <input type="text" id="usuario_login" placeholder="Usuario" required>
  <input type="password" id="clave_login" placeholder="Contrase√±a" required>
  <button type="submit" class="btn-grupo">Entrar</button>
</form>

<div class="text-center mt-4" id="logoutAdminWrapper" style="display:none;">
  <button type="button" class="btn-grupo" onclick="salirAdmin()">üö™ Salir de Admin</button>
</div>
  

  
<!-- Modifica tu HTML para un solo flujo -->
<div id="carrito">
  <div id="carritoCarousel" class="carousel slide" data-bs-ride="false">
    <div class="carousel-inner">
      
      <!-- Slide 1: Carrito -->
      <div class="carousel-item active">
        <h3>üõí Tu carrito</h3>
        <ul id="listaCarrito"></ul>
        <p><strong>Total:</strong> $<span id="totalCarrito">0</span></p>
        
        <form id="datosCliente" style="display: none;">
          <h4>üìù Tus datos</h4>
          <input type="text" name="nombre" placeholder="Nombre" class="form-control mb-2" required>
          <input type="text" name="apellido" placeholder="Apellido" class="form-control mb-2" required>
          <input type="email" name="email" placeholder="Email" class="form-control mb-2" required>
          <input type="tel" name="telefono" placeholder="Tel√©fono" class="form-control mb-2">
        </form>
        
        <div class="d-grid gap-2 mt-3">
          <button class="btn btn-sm btn-danger" onclick="vaciarCarrito()">Vaciar carrito</button>
          <button id="btnContinuar" class="btn btn-sm btn-success" onclick="mostrarFormulario()">
            Continuar con la compra
          </button>
          <button id="btnPagarFinal" class="btn btn-sm btn-primary" style="display: none;" onclick="pagarTodoJunto()">
            Pagar con Mercado Pago
          </button>
        </div>
      </div>
      
    </div>
  </div>
</div>

<button id="toggleCarrito">üõí</button>

<!-- Aviso flotante de precio actualizado -->
<div id="avisoPrecio" class="alert alert-success text-center" role="alert"
     style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;">
  ‚úî Precio actualizado
</div>

<!-- Aviso flotante de talle actualizado -->
<div id="avisoTalle" class="alert alert-info text-center" role="alert"
     style="display: none; position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 9999;">
  ‚úî Talle actualizado
</div>
  
<div id="imgModal" style="display:none;" onclick="closeModal()">
  <span class="close">&times;</span>
  <img id="modal-img" style="max-width:90%; max-height:90%;">
</div>
  
  <script>
const configWhatsApp = "https://wa.me/5492975158178";
// Opci√≥n B: leerlo de la URL si lo pas√°s como query param
const email = "ferj.9622@gmail.com";
const URL_BACKEND = "https://mpagina.onrender.com"; // Tu URL central

if (window.email) {
    email = window.email;
}
    
  // Mostrar/ocultar bot√≥n volver arriba
  window.addEventListener('scroll', () => {
    const btn = document.getElementById('volverArriba');
    btn.style.display = window.scrollY > 300 ? 'block' : 'none';
    btn.style.backgroundColor = 'white';
    btn.style.color = 'black';
  });

  document.getElementById('volverArriba').onclick = () => {
    window.scrollTo({ top: 0, behavior: 'auto' });
  };

document.getElementById("tallesProd").addEventListener("input", function() {
  const talles = this.value.split(",").map(t => t.trim()).filter(Boolean);
  const container = document.getElementById("stockPorTalleContainer");
  const simpleContainer = document.getElementById("stockSimple");
  
  if (talles.length > 0) {
    container.style.display = "block";
    simpleContainer.style.display = "none";
  } else {
    container.style.display = "none";
    simpleContainer.style.display = "block";
  }
});

function cargarProductoCompletoParaEditar(id_base) {
  const producto = window.todosLosProductos?.find(p => p.id_base === id_base);
  if (producto) {
    cargarProductoEnFormulario(producto);
  } else {
    alert("‚ùå No se encontr√≥ el producto para editar");
  }
}
function cargarProductoEnFormulario(producto) {
  console.log("üìù Cargando producto para editar:", producto.nombre);
  
  // Mostrar formulario admin
  const adminCard = document.getElementById("adminCard");
  adminCard.classList.remove("d-none");
  
  // Activar modo edici√≥n
  toggleModoEdicion(true);
  
  // Llenar campos
  document.getElementById("nombreProd").value = producto.nombre || "";
  document.getElementById("precioProd").value = producto.precio || "";
  document.getElementById("descripcionProd").value = producto.descripcion || "";
  
  // Talles
  if (Array.isArray(producto.talles)) {
    document.getElementById("tallesProd").value = producto.talles.join(", ");
  } else if (typeof producto.talles === 'string') {
    document.getElementById("tallesProd").value = producto.talles;
  } else {
    document.getElementById("tallesProd").value = "";
  }
  
  // Detectar si hay talles para mostrar campo de stock correspondiente
  const tallesArray = document.getElementById("tallesProd").value.split(",").map(t => t.trim()).filter(Boolean);
  if (tallesArray.length > 0) {
    document.getElementById("stockPorTalleContainer").style.display = "block";
    document.getElementById("stockSimple").style.display = "none";
  }
  
  // Stock por talle
  if (producto.stock_por_talle && Object.keys(producto.stock_por_talle).length > 0) {
    const stockPorTalle = producto.stock_por_talle;
    
    if (Object.keys(stockPorTalle)[0] === "unico") {
      // Producto sin talles
      document.getElementById("stockGeneral").value = stockPorTalle["unico"] || 0;
      document.getElementById("stockPorTalleContainer").style.display = "none";
      document.getElementById("stockSimple").style.display = "block";
    } else {
      // Producto con talles
      const stockPorTalleStr = Object.entries(stockPorTalle)
        .map(([talle, stock]) => `${talle}:${stock}`)
        .join(", ");
      document.getElementById("stockPorTalle").value = stockPorTalleStr;
      document.getElementById("stockPorTalleContainer").style.display = "block";
      document.getElementById("stockSimple").style.display = "none";
    }
  } else {
    // Fallback a stock general
    document.getElementById("stockGeneral").value = producto.stock || 0;
  }
  
  document.getElementById("grupoProd").value = producto.grupo || "";
  document.getElementById("subgrupoProd").value = producto.subgrupo || "";
  
  // Imagen
  if (producto.imagen_url) {
    const previewFoto = document.getElementById("previewFoto");
    previewFoto.src = producto.imagen_url;
    previewFoto.classList.remove("d-none");
    document.getElementById("btnQuitarFoto").classList.remove("d-none");
  }
  
  // Guardar ID del producto que estamos editando
  window.productoEditandoId = producto.id_base;
  
  // Scroll al formulario
  adminCard.scrollIntoView({ behavior: 'smooth' });
}
function toggleModoEdicion(editando) {
  const btnCancelar = document.getElementById("btnCancelarEdicion");
  const btnConfirmar = document.getElementById("btnConfirmarProd");
  
  if (editando) {
    btnCancelar.style.display = "block";
    btnConfirmar.innerHTML = "üíæ Actualizar Producto";
    btnConfirmar.classList.remove("btn-success");
    btnConfirmar.classList.add("btn-warning");
  } else {
    btnCancelar.style.display = "none";
    btnConfirmar.innerHTML = "‚úÖ Confirmar";
    btnConfirmar.classList.remove("btn-warning");
    btnConfirmar.classList.add("btn-success");
  }
}    
function resetearFormularioAdmin() {
  // Limpiar todos los campos
  document.getElementById("nombreProd").value = "";
  document.getElementById("precioProd").value = "";
  document.getElementById("descripcionProd").value = "";
  document.getElementById("tallesProd").value = "";
  document.getElementById("stockGeneral").value = "0";
  document.getElementById("stockPorTalle").value = "";
  document.getElementById("grupoProd").value = "";
  document.getElementById("subgrupoProd").value = "";
  
  // Resetear visibilidad
  document.getElementById("stockPorTalleContainer").style.display = "none";
  document.getElementById("stockSimple").style.display = "block";
  
  // Resetear foto
  document.getElementById("previewFoto").src = "";
  document.getElementById("previewFoto").classList.add("d-none");
  document.getElementById("btnQuitarFoto").classList.add("d-none");
  document.getElementById("inputFoto").value = "";
  window.fotoOptimizada = null;
  
  // Cambiar bot√≥n a modo creaci√≥n
  const btnConfirmar = document.getElementById("btnConfirmarProd");
  btnConfirmar.innerHTML = "‚úÖ Confirmar";
  btnConfirmar.classList.remove("btn-warning");
  btnConfirmar.classList.add("btn-success");
  
  // Ocultar bot√≥n cancelar
  document.getElementById("btnCancelarEdicion").style.display = "none";
  
  // Limpiar ID de edici√≥n
  window.productoEditandoId = null;
}
function actualizarStockPorTalle(idProducto, talleSeleccionado) {
  console.log(`üìä [actualizarStockPorTalle] id: ${idProducto}, talle: ${talleSeleccionado}`);
  
  const stockSpan = document.getElementById(`stock_${idProducto}`);
  const cantidadInput = document.getElementById(`cantidad_${idProducto}`);
  const agregarBtn = document.getElementById(`btn_agregar_${idProducto}`);
  
  if (!stockSpan || !cantidadInput || !agregarBtn) {
    console.warn("‚ö†Ô∏è Elementos no encontrados");
    return;
  }
  
  // üî• Obtener stock del talle seleccionado
  let stockDisponible = 0;
  const stockPorTalle = window[`stock_por_talle_${idProducto}`];
  
  if (stockPorTalle && stockPorTalle[talleSeleccionado] !== undefined) {
    stockDisponible = stockPorTalle[talleSeleccionado];
    console.log(`‚úÖ Stock obtenido: ${stockDisponible} para talle ${talleSeleccionado}`);
  } else {
    console.warn(`‚ö†Ô∏è Talle ${talleSeleccionado} no encontrado en stock_por_talle`);
    stockDisponible = 0;
  }
  
  // Actualizar UI
  stockSpan.textContent = stockDisponible > 0 ? stockDisponible : "Sin stock";
  
  if (stockDisponible > 0) {
    stockSpan.classList.remove("text-danger");
    stockSpan.classList.add("text-success");
    setTimeout(() => stockSpan.classList.remove("text-success"), 1000);
    
    cantidadInput.max = stockDisponible;
    cantidadInput.disabled = false;
    const valorActual = parseInt(cantidadInput.value) || 1;
    cantidadInput.value = Math.min(valorActual, stockDisponible);
    
    agregarBtn.disabled = false;
    agregarBtn.style.opacity = "1";
    agregarBtn.textContent = "Agregar al carrito";
  } else {
    stockSpan.classList.remove("text-success");
    stockSpan.classList.add("text-danger");
    
    cantidadInput.disabled = true;
    cantidadInput.value = "0";
    
    agregarBtn.disabled = true;
    agregarBtn.style.opacity = "0.5";
    agregarBtn.textContent = "Sin stock";
  }
}

    
// Cuando se hace click en "Editar" en un producto
window.cargarProductoEnFormulario = function(producto) {
  console.log("üìù Cargando producto para editar:", producto.nombre);
  
  // Mostrar formulario admin
  const adminCard = document.getElementById("adminCard");
  adminCard.classList.remove("d-none");
  
  // Activar modo edici√≥n
  toggleModoEdicion(true);
  
  // Llenar campos con datos del producto
  document.getElementById("nombreProd").value = producto.nombre || "";
  document.getElementById("precioProd").value = producto.precio || "";
  document.getElementById("descripcionProd").value = producto.descripcion || "";
  
  // Talles
  if (Array.isArray(producto.talles)) {
    document.getElementById("tallesProd").value = producto.talles.join(", ");
  } else if (typeof producto.talles === 'string') {
    document.getElementById("tallesProd").value = producto.talles;
  } else {
    document.getElementById("tallesProd").value = "";
  }
  
  // Detectar si hay talles para mostrar campo de stock correspondiente
  const tallesArray = document.getElementById("tallesProd").value.split(",").map(t => t.trim()).filter(Boolean);
  if (tallesArray.length > 0) {
    document.getElementById("stockPorTalleContainer").style.display = "block";
    document.getElementById("stockSimple").style.display = "none";
  }
  
  // Stock por talle
  if (producto.stock_por_talle && Object.keys(producto.stock_por_talle).length > 0) {
    const stockPorTalle = producto.stock_por_talle;
    
    if (Object.keys(stockPorTalle)[0] === "unico") {
      // Producto sin talles
      document.getElementById("stockGeneral").value = stockPorTalle["unico"] || 0;
      document.getElementById("stockPorTalleContainer").style.display = "none";
      document.getElementById("stockSimple").style.display = "block";
    } else {
      // Producto con talles
      const stockPorTalleStr = Object.entries(stockPorTalle)
        .map(([talle, stock]) => `${talle}:${stock}`)
        .join(", ");
      document.getElementById("stockPorTalle").value = stockPorTalleStr;
      document.getElementById("stockPorTalleContainer").style.display = "block";
      document.getElementById("stockSimple").style.display = "none";
    }
  } else {
    // Fallback a stock general
    document.getElementById("stockGeneral").value = producto.stock || 0;
  }
  
  document.getElementById("grupoProd").value = producto.grupo || "";
  document.getElementById("subgrupoProd").value = producto.subgrupo || "";
  
  // Imagen
  if (producto.imagen_url) {
    const previewFoto = document.getElementById("previewFoto");
    previewFoto.src = producto.imagen_url;
    previewFoto.classList.remove("d-none");
    document.getElementById("btnQuitarFoto").classList.remove("d-none");
  }
  
  // Guardar ID del producto que estamos editando
  window.productoEditandoId = producto.id_base;
  
  // Scroll al formulario
  adminCard.scrollIntoView({ behavior: 'smooth' });
  
  console.log("‚úÖ Producto cargado en formulario para edici√≥n:", producto.nombre);
};
    
/////////////////////////////////
function habilitarScrollHorizontal(selector) {
  const panel = document.querySelector(selector);
  if (!panel) return;

  // 1Ô∏è‚É£ Scroll horizontal con la rueda del mouse (animado)
  panel.addEventListener('wheel', (e) => {
    e.preventDefault(); // evita scroll vertical
    panel.scrollBy({
      left: e.deltaY,
      behavior: 'smooth' // animaci√≥n suave
    });
  });

  // 2Ô∏è‚É£ Scroll horizontal arrastrando con el mouse
  let isDown = false;
  let startX;
  let scrollLeft;

  panel.addEventListener('mousedown', (e) => {
    isDown = true;
    panel.classList.add('active'); // opcional: estilo visual
    startX = e.pageX - panel.offsetLeft;
    scrollLeft = panel.scrollLeft;
  });

  panel.addEventListener('mouseleave', () => {
    isDown = false;
    panel.classList.remove('active');
  });

  panel.addEventListener('mouseup', () => {
    isDown = false;
    panel.classList.remove('active');
  });

  panel.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - panel.offsetLeft;
    const walk = (x - startX); // cantidad de movimiento
    panel.scrollLeft = scrollLeft - walk;
  });
}

// Activar en ambos paneles
habilitarScrollHorizontal('.panel-grupos');
habilitarScrollHorizontal('.panel-subcategorias');

////////////////////////////////////////////////////     
// Configuraci√≥n de paginaci√≥n
const itemsPorPagina = 12;
let totalPaginas = 0;

// üëâ Flag de admin (puede venir de tu token backend)
const modoAdmin = window.tokenAdminEmail ? true : false;

if (modoAdmin) {
  document.getElementById("adminCard").classList.remove("d-none");
}   
// üëá NUEVAS FUNCIONES PARA EDITAR STOCK (SOLO MODO ADMIN)

function editarStock(id) {
  console.log("üîç [editarStock] Llamado con id:", id);
  
  const span = document.getElementById("stock_" + id);
  if (!span) {
    console.error("‚ùå No se encontr√≥ el span stock_" + id);
    return;
  }

  let valorActual = span.textContent.trim();
  
  // Convertir "Sin stock" a 0
  if (valorActual === "Sin stock" || valorActual === "sin stock") {
    valorActual = "0";
  }
  
  console.log("üìù Valor actual de stock:", valorActual);

  const input = document.createElement("input");
  input.type = "number";
  input.min = "0";
  input.value = valorActual;
  input.defaultValue = valorActual; // Guardar valor original
  input.className = "form-control form-control-sm d-inline-block";
  input.style.width = "80px";
  input.id = "input_stock_" + id;

  input.onblur = () => guardarStock(id);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      input.blur();
    }
  });

  // Guardar referencia al span original para poder revertir
  input.dataset.originalValue = valorActual;
  
  span.replaceWith(input);
  input.focus();
  input.select();
}

function guardarStock(id) {
  const input = document.getElementById("input_stock_" + id);
  if (!input) {
    console.warn("‚ùå No se encontr√≥ el input de stock:", "input_stock_" + id);
    alert("‚ùå Error interno: No se encontr√≥ el campo de stock");
    return;
  }

  const nuevoStock = parseInt(input.value) || 0;
  
  if (nuevoStock < 0) {
    alert("‚ùå El stock no puede ser negativo");
    input.value = "0";
    return;
  }

  // üî• Obtener el talle seleccionado
  const talleSelect = document.getElementById(`talle_${id}`);
  const talle = talleSelect?.value || "unico"; // "unico" para productos sin talles
  
  console.log("üì° [guardarStock] Enviando a backend:", { 
    id: id, 
    talle: talle,
    stock: nuevoStock,
    email: email
  });

  if (!email || email === "") {
    alert("‚ùå Error: No se detect√≥ el email del vendedor. Recarga la p√°gina.");
    console.error("üí• email est√° vac√≠o:", email);
    return;
  }

  // üî• Enviar actualizaci√≥n del stock por talle
  fetch(`${URL_BACKEND}/actualizar-stock-talle`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ 
      id: id,
      talle: talle,
      stock: nuevoStock,
      email: email
    })
  })
  .then(res => {
    console.log("üì° Respuesta HTTP recibida, status:", res.status);
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    return res.json();
  })
  .then(data => {
    console.log("üì© Respuesta backend actualizar-stock-talle:", data);

    if (data.status === "ok") {
      // 1. Actualizar la variable local stock_por_talle
      if (!window[`stock_por_talle_${id}`]) {
        window[`stock_por_talle_${id}`] = {};
      }
      window[`stock_por_talle_${id}`][talle] = nuevoStock;
      
      // 2. Actualizar texto en DOM
      const span = document.createElement("span");
      span.id = "stock_" + id;
      span.textContent = nuevoStock > 0 ? nuevoStock : "Sin stock";
      span.className = nuevoStock > 0 ? "text-success" : "text-danger";
      input.replaceWith(span);
      setTimeout(() => {
        span.classList.remove("text-success", "text-danger");
        span.className = nuevoStock > 0 ? "" : "text-danger";
      }, 1000);
      
      // 3. Actualizar el input de cantidad
      const cantidadInput = document.getElementById("cantidad_" + id);
      const agregarBtn = cantidadInput?.closest(".d-flex")?.querySelector("button");
      
      if (cantidadInput && agregarBtn) {
        if (nuevoStock > 0) {
          cantidadInput.max = nuevoStock;
          cantidadInput.disabled = false;
          const valorActual = parseInt(cantidadInput.value) || 1;
          cantidadInput.value = Math.min(valorActual, nuevoStock);
          agregarBtn.disabled = false;
          agregarBtn.style.opacity = "1";
          agregarBtn.textContent = "Agregar al carrito";
        } else {
          cantidadInput.disabled = true;
          cantidadInput.value = "0";
          agregarBtn.disabled = true;
          agregarBtn.style.opacity = "0.5";
          agregarBtn.textContent = "Sin stock";
        }
        console.log("‚úÖ Input cantidad actualizado, nuevo stock=", nuevoStock);
      }
      
      // 4. Mostrar aviso visual
      mostrarAvisoStock();
      
    } else {
      console.error("‚ùå Error en respuesta backend:", data);
      alert("‚ùå No se pudo actualizar el stock: " + (data.message || data.error || "Error desconocido"));
      
      // Revertir input
      const span = document.createElement("span");
      span.id = "stock_" + id;
      span.textContent = input.defaultValue || "0";
      span.className = "text-danger";
      input.replaceWith(span);
    }
  })
  .catch(err => {
    console.error("üí• Error de conexi√≥n en guardarStock:", err);
    alert("‚ùå Error de conexi√≥n al guardar el stock");
    
    // Revertir en caso de error
    const span = document.createElement("span");
    span.id = "stock_" + id;
    span.textContent = input.defaultValue || "0";
    span.className = "text-danger";
    input.replaceWith(span);
  });
}

function mostrarAvisoStock() {
  // Crear aviso si no existe
  let aviso = document.getElementById("avisoStock");
  if (!aviso) {
    aviso = document.createElement("div");
    aviso.id = "avisoStock";
    aviso.className = "alert alert-info text-center";
    aviso.role = "alert";
    aviso.textContent = "‚úî Stock actualizado";
    aviso.style.cssText = "display: none; position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 10px 20px; border-radius: 5px;";
    document.body.appendChild(aviso);
  }
  
  aviso.style.display = "block";
  setTimeout(() => {
    aviso.style.display = "none";
  }, 2000);
}
    
function openModal(src) {
  const modal = document.getElementById("imgModal");
  document.getElementById("modal-img").src = src;
  modal.style.display = "flex";
  setTimeout(() => modal.classList.add("show"), 10); // activa animaci√≥n
}

function validarStockDisponible(idProducto, talle, cantidad) {
  const stockPorTalle = window[`stock_por_talle_${idProducto}`];
  if (!stockPorTalle) return true;
  
  const stockActual = stockPorTalle[talle] || 0;
  return cantidad <= stockActual;
}
    
function closeModal() {
  const modal = document.getElementById("imgModal");
  modal.classList.remove("show");
  setTimeout(() => modal.style.display = "none", 300); // espera animaci√≥n
}
// ========== FUNCIONES NUEVAS PARA EL CARRITO ==========

// 1. Mostrar formulario de datos del cliente (NUEVA)
function mostrarFormulario() {
    console.log("üìù Mostrando formulario de datos del cliente");
    
    // Mostrar el formulario de datos del cliente
    const datosCliente = document.getElementById('datosCliente');
    if (datosCliente) {
        datosCliente.style.display = 'block';
    }
    
    // Ocultar el bot√≥n "Continuar con la compra"
    const btnContinuar = document.getElementById('btnContinuar');
    if (btnContinuar) {
        btnContinuar.style.display = 'none';
    }
    
    // Mostrar el bot√≥n "Pagar con Mercado Pago"
    const btnPagarFinal = document.getElementById('btnPagarFinal');
    if (btnPagarFinal) {
        btnPagarFinal.style.display = 'block';
    }
    
    // Hacer scroll al formulario
    setTimeout(() => {
        const carrito = document.getElementById('carrito');
        if (carrito) {
            carrito.scrollTo({ top: carrito.scrollHeight, behavior: 'smooth' });
        }
    }, 100);
}

// 2. Ocultar formulario de datos del cliente (NUEVA)
function ocultarFormulario() {
    const datosCliente = document.getElementById('datosCliente');
    if (datosCliente) {
        datosCliente.style.display = 'none';
    }
    
    const btnContinuar = document.getElementById('btnContinuar');
    if (btnContinuar) {
        btnContinuar.style.display = 'block';
    }
    
    const btnPagarFinal = document.getElementById('btnPagarFinal');
    if (btnPagarFinal) {
        btnPagarFinal.style.display = 'none';
    }
}

// 3. Procesar pago completo (NUEVA)
async function pagarTodoJunto() {
    console.log("üõí Iniciando proceso de pago...");
    
    // 1. Validar que hay productos en el carrito
    if (carrito.length === 0) {
        alert("‚ùå El carrito est√° vac√≠o");
        return;
    }
    
    // 2. Obtener datos del formulario
    const nombreInput = document.querySelector('input[name="nombre"]');
    const apellidoInput = document.querySelector('input[name="apellido"]');
    const emailInput = document.querySelector('input[name="email"]');
    const telefonoInput = document.querySelector('input[name="telefono"]');
    
    if (!nombreInput || !apellidoInput || !emailInput) {
        alert("‚ùå Por favor completa todos los campos obligatorios");
        return;
    }
    
    const nombre = nombreInput.value.trim();
    const apellido = apellidoInput.value.trim();
    const emailCliente = emailInput.value.trim();
    const telefono = telefonoInput?.value?.trim() || "";
    
    if (!nombre || !apellido || !emailCliente) {
        alert("‚ùå Nombre, apellido y email son obligatorios");
        return;
    }
    
    // 3. Validar email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(emailCliente)) {
        alert("‚ùå Por favor ingresa un email v√°lido");
        return;
    }
    
    // 4. Generar un ID √∫nico para esta orden
    const orden_id = 'ORD_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // 5. Funci√≥n para convertir precio a n√∫mero
    function convertirPrecio(precio) {
        if (typeof precio === 'number') {
            return precio;
        }
        if (typeof precio === 'string') {
            // Remover s√≠mbolo $, comas y espacios
            const limpio = precio.replace(/[$\s,]/g, '').trim();
            const num = parseFloat(limpio);
            return isNaN(num) ? 0 : num;
        }
        return 0;
    }
    
    // 6. Funci√≥n para convertir cantidad a n√∫mero
    function convertirCantidad(cantidad) {
        const num = parseInt(cantidad);
        return isNaN(num) || num < 1 ? 1 : num;
    }
    
    // 7. Preparar el payload para el backend
    const itemsMP = []; // Para Mercado Pago
    const itemsCarrito = []; // Para Firestore
    
    let totalCalculado = 0;
    
    carrito.forEach(item => {
        // Convertir precios y cantidades
        const precio = convertirPrecio(item.precio);
        const cantidad = convertirCantidad(item.cantidad);
        const subtotal = precio * cantidad;
        totalCalculado += subtotal;
        
        // Item para Mercado Pago
        itemsMP.push({
            title: item.nombre + (item.talle ? ` (${item.talle})` : ""),
            quantity: cantidad,
            unit_price: precio,
            currency_id: "ARS"
        });
        
        // Item para Firestore (formato completo)
        itemsCarrito.push({
            nombre: item.nombre,
            precio: precio,
            cantidad: cantidad,
            talle: item.talle || "",
            id_base: item.id_base || "",
            grupo: item.grupo || "",
            subgrupo: item.subgrupo || "",
            subtotal: subtotal
        });
    });
    
    const payload = {
        email_vendedor: email,
        carrito: itemsCarrito,  // Enviar carrito completo con precios convertidos
        items_mp: itemsMP,      // Enviar tambi√©n items formateados para MP
        total: totalCalculado,
        cliente_nombre: `${nombre} ${apellido}`.trim(),
        cliente_email: emailCliente,
        cliente_telefono: telefono,
        orden_id: orden_id,
        url_retorno: window.location.href
    };
    
    console.log("üì¶ Payload para el pago:", payload);
    console.log("üí∞ Total calculado:", totalCalculado);
    console.log("üõí Items procesados:", itemsCarrito.length);
    
    // Debug: mostrar precios convertidos
    itemsCarrito.forEach((item, idx) => {
        console.log(`  ${idx+1}. ${item.nombre}: $${item.precio} x ${item.cantidad} = $${item.subtotal}`);
    });
    
    try {
        // Mostrar indicador de carga
        const btnPagarFinal = document.getElementById('btnPagarFinal');
        if (btnPagarFinal) {
            btnPagarFinal.disabled = true;
            btnPagarFinal.textContent = 'Procesando...';
        }
        
        // 8. Enviar al backend para crear la preferencia de pago
        const response = await fetch(`${URL_BACKEND}/pagar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Error HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log("‚úÖ Respuesta del backend:", data);
        
        // 9. Manejar la respuesta
        if (data.error) {
            alert("‚ùå Error: " + data.error);
        } else if (data.init_point) {
            // Guardar el ID de la orden en localStorage para referencia
            localStorage.setItem('ultima_orden_id', orden_id);
            localStorage.setItem('ultima_orden_data', JSON.stringify({
                fecha: new Date().toISOString(),
                items: carrito.length,
                total: totalCalculado,
                cliente: `${nombre} ${apellido}`,
                email: emailCliente
            }));
            
            // Redirigir a Mercado Pago
            console.log("‚û°Ô∏è Redirigiendo a Mercado Pago...");
            window.location.href = data.init_point;
        } else if (data.preference_id && window.mp) {
            // Usar SDK de Mercado Pago si est√° disponible
            localStorage.setItem('ultima_orden_id', orden_id);
            
            window.mp.checkout({
                preference: { id: data.preference_id },
                autoOpen: true
            });
        } else {
            console.warn("Respuesta inesperada del backend:", data);
            alert("‚ö†Ô∏è No se pudo procesar el pago. Intenta de nuevo.");
        }
        
    } catch (error) {
        console.error("üí• Error al procesar el pago:", error);
        alert("‚ùå Error al procesar el pago: " + error.message);
    } finally {
        // Restaurar bot√≥n
        const btnPagarFinal = document.getElementById('btnPagarFinal');
        if (btnPagarFinal) {
            btnPagarFinal.disabled = false;
            btnPagarFinal.textContent = 'Pagar con Mercado Pago';
        }
    }
}

// 4. Modificar la funci√≥n vaciarCarrito existente para que tambi√©n oculte el formulario
// Reemplaza tu funci√≥n vaciarCarrito existente con esta:
function vaciarCarrito() {
    carrito = [];
    actualizarCarrito();
    ocultarFormulario(); // Esto es lo nuevo que agregamos
}
    
// üëâ Mostrar/ocultar botones eliminar seg√∫n modo admin
function toggleModoAdmin(activo) {
  document.querySelectorAll(".btnEliminarCard").forEach(btn => {
    if (activo) {
      btn.classList.remove("d-none");
    } else {
      btn.classList.add("d-none");
    }
  });
}

function editarVariantes(idProducto) {
  // Crear modal para gestionar variantes
  const modalHTML = `
    <div class="modal fade" id="modalVariantes" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">üé® Gestionar Variantes</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="listaVariantes"></div>
            <hr>
            <h6>‚ûï Agregar nueva variante</h6>
            <div class="row g-2">
              <div class="col-md-4">
                <input type="text" id="nuevoTalle" class="form-control" placeholder="Talle">
              </div>
              <div class="col-md-4">
                <input type="text" id="nuevoColor" class="form-control" placeholder="Color">
              </div>
              <div class="col-md-4">
                <input type="number" id="nuevoStock" class="form-control" placeholder="Stock" min="0">
              </div>
            </div>
            <button class="btn btn-success mt-2" onclick="agregarVariante('${idProducto}')">
              ‚ûï Agregar Variante
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // A√±adir modal al DOM si no existe
  if (!document.getElementById('modalVariantes')) {
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  // Cargar variantes existentes
  cargarListaVariantes(idProducto);
  
  // Mostrar modal
  const modal = new bootstrap.Modal(document.getElementById('modalVariantes'));
  modal.show();
}

// Cargar lista de variantes en el modal
async function cargarListaVariantes(idProducto) {
  try {
    const response = await fetch(`${URL_BACKEND}/api/variantes/${idProducto}`);
    const variantes = await response.json();
    
    const listaDiv = document.getElementById('listaVariantes');
    listaDiv.innerHTML = '';
    
    if (!Array.isArray(variantes) || variantes.length === 0) {
      listaDiv.innerHTML = '<p class="text-muted">No hay variantes configuradas.</p>';
      return;
    }
    
    const tablaHTML = `
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Talle</th>
            <th>Color</th>
            <th>Stock</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          ${variantes.map(v => `
            <tr>
              <td>${v.talle || ''}</td>
              <td>${v.color || ''}</td>
              <td>
                <input type="number" 
                       id="stock_${v.id}" 
                       value="${v.stock || 0}" 
                       class="form-control form-control-sm w-auto d-inline"
                       onchange="actualizarStockVariante('${v.id}', this.value)">
              </td>
              <td>
                <button class="btn btn-sm btn-danger" 
                        onclick="eliminarVariante('${v.id}')">
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    
    listaDiv.innerHTML = tablaHTML;
  } catch (error) {
    console.error('Error cargando variantes:', error);
  }
}

function actualizarStockVariante(idVariante, nuevoStock) {
  const productoId = window.currentProductoId; // Debes guardar esto al abrir el modal
  
  fetch(`${URL_BACKEND}/api/variantes/${idVariante}/actualizar`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      stock: parseInt(nuevoStock) || 0,
      producto_id: productoId,  // ‚Üê AGREGAR ESTO
      email: window.email
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'ok') {
      mostrarAviso('‚úÖ Stock actualizado');
      // Actualizar stock general en la vista
      if (data.id_producto) {
        const stockSpan = document.getElementById(`stock_${data.id_producto}`);
        if (stockSpan) {
          stockSpan.textContent = data.stock_total || '0';
        }
      }
    }
  });
}

function agregarVariante(idProducto) {
  const talle = document.getElementById('nuevoTalle').value.trim();
  const color = document.getElementById('nuevoColor').value.trim();
  const stock = parseInt(document.getElementById('nuevoStock').value) || 0;
  
  if (!talle || !color) {
    alert('‚ùå Talle y color son requeridos');
    return;
  }
  
  fetch(`${URL_BACKEND}/api/variantes/${idProducto}/crear`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ talle, color, stock })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'ok') {
      mostrarAviso('‚úÖ Variante agregada');
      cargarListaVariantes(idProducto);
      
      // Limpiar campos
      document.getElementById('nuevoTalle').value = '';
      document.getElementById('nuevoColor').value = '';
      document.getElementById('nuevoStock').value = '';
    }
  });
}

// Eliminar variante
function eliminarVariante(idVariante) {
  if (!confirm('¬øEliminar esta variante?')) return;
  
  fetch(`${URL_BACKEND}/api/variantes/${idVariante}/eliminar`, {
    method: 'DELETE'
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'ok') {
      mostrarAviso('‚úÖ Variante eliminada');
      cargarListaVariantes(data.id_producto);
    }
  });
}
    
function abrirConfigMercadoPago() {
    console.log("‚öôÔ∏è Redirigiendo a configuraci√≥n de Mercado Pago...");
    
    // üëâ Obtener la URL actual del vendedor (SU p√°gina)
    const urlRetorno = window.location.href;
    
    // üëâ Usamos URL_BACKEND para que siempre apunte al backend correcto
    const configUrl = `${URL_BACKEND}/conectar_mp?email=${encodeURIComponent(email)}&url_retorno=${encodeURIComponent(urlRetorno)}`;
    
    console.log("üîó Redirigiendo a:", configUrl);
    console.log("üìç URL de retorno (p√°gina del vendedor):", urlRetorno);
    
    window.location.href = configUrl;
}
    
async function eliminarProducto(id_base) {
  console.log("[ELIMINAR_PRODUCTO] üîî Click en bot√≥n eliminar ‚Üí id_base:", id_base);

  try {
    console.log("[ELIMINAR_PRODUCTO] üì° Enviando request al backend...");
    const resp = await fetch("https://mpagina.onrender.com/eliminar-producto", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id_base, email }) // üëà usa la variable global
    });

    console.log("[ELIMINAR_PRODUCTO] üì• Status HTTP:", resp.status);
    const data = await resp.json();
    console.log("[ELIMINAR_PRODUCTO] üìÑ Respuesta JSON:", data);

    if (data.status === "ok") {
      const card = document.querySelector(`[data-id="${id_base}"]`);
      if (card) {
        card.remove();
        console.log("[ELIMINAR_PRODUCTO] üóëÔ∏è Card eliminada del DOM:", id_base);
      } else {
        console.warn("[ELIMINAR_PRODUCTO] ‚ö†Ô∏è No se encontr√≥ la card en el DOM para id_base:", id_base);
      }
    } else {
      console.error("[ELIMINAR_PRODUCTO] ‚ùå Error reportado por backend:", data.error);
      alert("Error al eliminar producto: " + data.error);
    }
  } catch (err) {
    console.error("[ELIMINAR_PRODUCTO] üí• Excepci√≥n inesperada:", err);
    alert("Error al eliminar producto: " + err.message);
  }
}
    
// üëâ Optimizar imagen igual que Step0 ‚Üí resize a 300x180, WebP q=0.8
async function optimizarImagen(file) {
  console.log(`üìÇ [optimizarImagen] Iniciando optimizaci√≥n: ${file.name} (${file.size} bytes)`);

  const imgUrl = URL.createObjectURL(file);
  try {
    const img = await new Promise((resolve, reject) => {
      const image = new Image();
      image.onload = () => {
        console.log(`‚úÖ [optimizarImagen] Imagen cargada: ${image.width}x${image.height}px`);
        resolve(image);
      };
      image.onerror = reject;
      image.src = imgUrl;
    });

    const targetW = 500, targetH = 500;
    const canvas = document.createElement("canvas");
    canvas.width = targetW;
    canvas.height = targetH;
    const ctx = canvas.getContext("2d", { alpha: true });

    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = "high";
    ctx.clearRect(0, 0, targetW, targetH);

    const ratio = Math.min(targetW / img.width, targetH / img.height);
    const newW = Math.max(1, Math.round(img.width * ratio));
    const newH = Math.max(1, Math.round(img.height * ratio));
    const offsetX = Math.floor((targetW - newW) / 2);
    const offsetY = Math.floor((targetH - newH) / 2);

    console.log(`üìê [optimizarImagen] Escalado ‚Üí newW=${newW}, newH=${newH}, offsetX=${offsetX}, offsetY=${offsetY}`);
    ctx.drawImage(img, offsetX, offsetY, newW, newH);

    const blob = await new Promise((resolve, reject) => {
      canvas.toBlob(b => {
        if (b && b.size > 0) {
          console.log(`‚úÖ [optimizarImagen] Blob generado (${b.size} bytes)`);
          resolve(b);
        } else {
          reject(new Error("‚ùå No se pudo generar WebP"));
        }
      }, "image/webp", 0.8);
    });

    return blob;
  } finally {
    URL.revokeObjectURL(imgUrl);
    console.log(`üßπ [optimizarImagen] URL revocada`);
  }
}

// üëâ Preview inmediato de la foto optimizada
document.getElementById("inputFoto").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  try {
    const blobOptimizado = await optimizarImagen(file);
    window.fotoOptimizada = blobOptimizado;

    const urlPreview = URL.createObjectURL(blobOptimizado);
    const imgPreview = document.getElementById("previewFoto");
    imgPreview.src = urlPreview;
    imgPreview.classList.remove("d-none");

    console.log("üëÅÔ∏è Preview inmediato mostrado");
  } catch (err) {
    console.error("üí• Error al optimizar imagen:", err);
    alert("‚ùå No se pudo optimizar la imagen");
  }
});

document.getElementById("tallesProd").addEventListener("input", function() {
  const talles = this.value.split(",").map(t => t.trim()).filter(Boolean);
  const container = document.getElementById("stockPorTalleContainer");
  const simpleContainer = document.getElementById("stockSimple");
  
  if (talles.length > 0) {
    container.style.display = "block";
    simpleContainer.style.display = "none";
  } else {
    container.style.display = "none";
    simpleContainer.style.display = "block";
  }
});
    
document.getElementById("btnConfirmarProd").addEventListener("click", async () => {
  const email = "ferj.9622@gmail.com";
  if (!email) {
    alert("‚ùå No hay email de admin, no se puede guardar");
    return;
  }

  try {
    // 1. Subir foto optimizada
    let foto_url = "";
    if (window.fotoOptimizada) {
      const formData = new FormData();
      formData.append("file", window.fotoOptimizada, "producto.jpg");
      formData.append("email", email);

      console.log("üì° Subiendo foto...");
      const respFoto = await fetch("https://mpagina.onrender.com/subir-foto", {
        method: "POST",
        body: formData
      });

      if (!respFoto.ok) {
        const text = await respFoto.text();
        throw new Error(`Error al subir foto: ${respFoto.status} ${text}`);
      }

      const fotoData = await respFoto.json();
      foto_url = fotoData.url || "";
      console.log("‚úÖ Foto subida:", foto_url);
    } else if (window.productoEditandoId) {
      const productoExistente = window.todosLosProductos?.find(p => p.id_base === window.productoEditandoId);
      foto_url = productoExistente?.imagen_url || "";
      console.log("üîÑ Manteniendo foto existente:", foto_url);
    }

    // 2. Obtener datos del formulario
    const nombre = document.getElementById("nombreProd").value.trim();
    const precio = parseFloat(document.getElementById("precioProd").value);
    const descripcion = document.getElementById("descripcionProd").value.trim();
    const tallesRaw = document.getElementById("tallesProd").value.trim();
    const grupo = document.getElementById("grupoProd")?.value.trim() || "General";
    const subgrupo = document.getElementById("subgrupoProd")?.value.trim() || "general";

    if (!nombre || isNaN(precio) || precio <= 0 || !grupo) {
      alert("‚ùå Faltan campos obligatorios: nombre/grupo/precio");
      return;
    }

    // 3. Procesar stock
    let stockPorTalle = {};
    const talles = tallesRaw ? tallesRaw.split(",").map(t => t.trim()).filter(Boolean) : [];
    
    if (talles.length > 0) {
      const stockTalleInput = document.getElementById("stockPorTalle").value.trim();
      
      if (stockTalleInput) {
        stockTalleInput.split(",").forEach(item => {
          const parts = item.split(":").map(s => s.trim());
          if (parts.length >= 2) {
            const talle = parts[0];
            const stock = parseInt(parts[1]) || 0;
            if (talle && !isNaN(stock)) {
              stockPorTalle[talle] = stock;
            }
          }
        });
        
        talles.forEach(talle => {
          if (stockPorTalle[talle] === undefined) {
            stockPorTalle[talle] = 0;
          }
        });
      } else {
        talles.forEach(talle => stockPorTalle[talle] = 0);
      }
    } else {
      const stockGeneral = parseInt(document.getElementById("stockGeneral").value) || 0;
      stockPorTalle = {"unico": stockGeneral};
    }

    console.log("üì¶ Stock procesado:", stockPorTalle);

    // üî• 4. Crear objeto producto
    const producto = {
      nombre: nombre,
      precio: precio,
      descripcion: descripcion || "",
      talles: talles,
      grupo: grupo,
      subgrupo: subgrupo,
      stock_por_talle: stockPorTalle,
      imagen_url: foto_url
    };

    // üî• 5. Preparar payload con ES_EDICION (no forzar_nuevo)
    const esEdicion = window.productoEditandoId ? true : false;
    const payload = {
      producto: producto,
      email: email,
      es_edicion: esEdicion  // üî• CAMBIADO: es_edicion en lugar de forzar_nuevo
    };

    // Si es edici√≥n, tambi√©n enviar id_base DENTRO del producto
    if (esEdicion) {
      payload.producto.id_base = window.productoEditandoId;
      console.log("üîÑ Modo EDICI√ìN para ID:", window.productoEditandoId);
    } else {
      console.log("‚ûï Modo CREACI√ìN de nuevo producto");
    }

    console.log("üì§ Payload para backend:", JSON.stringify(payload, null, 2));
    console.log("‚öôÔ∏è Par√°metro es_edicion:", payload.es_edicion);

    // üî• 6. Enviar al backend
    const endpoint = "https://mpagina.onrender.com/guardar-producto";
    
    const respGuardar = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!respGuardar.ok) {
      const text = await respGuardar.text();
      console.error("‚ùå Error del servidor:", text);
      throw new Error(`Error al guardar producto: ${respGuardar.status} ${text}`);
    }

    const data = await respGuardar.json();
    console.log("üì© Respuesta backend:", data);

    if (data.status === "ok") {
      const mensaje = esEdicion ? 
        "‚úÖ Producto actualizado correctamente" : 
        "‚úÖ Producto creado correctamente";
      alert(mensaje);
      
      // 7. Limpiar formulario
      resetFormularioAdmin();
      
      // 8. Ocultar formulario
      document.getElementById("adminCard").classList.add("d-none");
      
      // 9. Refrescar
      setTimeout(() => {
        if (typeof cargarProductos === "function") {
          cargarProductos();
        } else {
          location.reload();
        }
      }, 1000);
      
    } else {
      console.error("‚ùå Error al guardar producto:", data);
      alert("‚ùå " + (data.error || data.message || "Error al guardar producto"));
    }
  } catch (err) {
    console.error("üí• Error en flujo de confirmaci√≥n:", err);
    alert("‚ùå Error al guardar producto: " + err.message);
  }
});

// üî• Funci√≥n auxiliar para resetear formulario
function resetFormularioAdmin() {
  document.getElementById("nombreProd").value = "";
  document.getElementById("precioProd").value = "";
  document.getElementById("descripcionProd").value = "";
  document.getElementById("tallesProd").value = "";
  document.getElementById("stockGeneral").value = "0";
  document.getElementById("stockPorTalle").value = "";
  document.getElementById("grupoProd").value = "";
  document.getElementById("subgrupoProd").value = "";
  
  document.getElementById("stockPorTalleContainer").style.display = "none";
  document.getElementById("stockSimple").style.display = "block";
  
  document.getElementById("previewFoto").src = "";
  document.getElementById("previewFoto").classList.add("d-none");
  document.getElementById("btnQuitarFoto").classList.add("d-none");
  document.getElementById("inputFoto").value = "";
  
  window.fotoOptimizada = null;
  window.productoEditandoId = null;
  
  const btnConfirmar = document.getElementById("btnConfirmarProd");
  btnConfirmar.innerHTML = "‚úÖ Confirmar";
  btnConfirmar.classList.remove("btn-warning");
  btnConfirmar.classList.add("btn-success");
  
  const btnCancelar = document.getElementById("btnCancelarEdicion");
  if (btnCancelar) {
    btnCancelar.style.display = "none";
  }
}

// üî• FUNCI√ìN PARA CARGAR PRODUCTO EN FORMULARIO (EDICI√ìN)
function cargarProductoEnFormulario(producto) {
  console.log("üìù Cargando producto para editar:", producto.nombre);
  
  // Mostrar formulario admin
  const adminCard = document.getElementById("adminCard");
  adminCard.classList.remove("d-none");
  
  // Cambiar t√≠tulo del bot√≥n a "Actualizar"
  const btnConfirmar = document.getElementById("btnConfirmarProd");
  btnConfirmar.innerHTML = "üíæ Actualizar Producto";
  btnConfirmar.classList.remove("btn-success");
  btnConfirmar.classList.add("btn-warning");
  
  // Llenar campos con datos del producto (INCLUYENDO DESCRIPCI√ìN)
  document.getElementById("nombreProd").value = producto.nombre || "";
  document.getElementById("precioProd").value = producto.precio || "";
  document.getElementById("descripcionProd").value = producto.descripcion || ""; // ‚Üê CARGA DESCRIPCI√ìN
  
  // Talles
  if (Array.isArray(producto.talles)) {
    document.getElementById("tallesProd").value = producto.talles.join(", ");
  } else if (typeof producto.talles === 'string') {
    document.getElementById("tallesProd").value = producto.talles;
  } else {
    document.getElementById("tallesProd").value = "";
  }
  
  // Detectar si hay talles para mostrar campo de stock correspondiente
  const tallesArray = document.getElementById("tallesProd").value.split(",").map(t => t.trim()).filter(Boolean);
  if (tallesArray.length > 0) {
    document.getElementById("stockPorTalleContainer").style.display = "block";
    document.getElementById("stockSimple").style.display = "none";
  }
  
  // Stock por talle
  if (producto.stock_por_talle && Object.keys(producto.stock_por_talle).length > 0) {
    const stockPorTalle = producto.stock_por_talle;
    
    if (Object.keys(stockPorTalle)[0] === "unico") {
      // Producto sin talles
      document.getElementById("stockGeneral").value = stockPorTalle["unico"] || 0;
      document.getElementById("stockPorTalleContainer").style.display = "none";
      document.getElementById("stockSimple").style.display = "block";
    } else {
      // Producto con talles
      const stockPorTalleStr = Object.entries(stockPorTalle)
        .map(([talle, stock]) => `${talle}:${stock}`)
        .join(", ");
      document.getElementById("stockPorTalle").value = stockPorTalleStr;
      document.getElementById("stockPorTalleContainer").style.display = "block";
      document.getElementById("stockSimple").style.display = "none";
    }
  } else {
    // Fallback a stock general
    document.getElementById("stockGeneral").value = producto.stock || 0;
  }
  
  document.getElementById("grupoProd").value = producto.grupo || "";
  document.getElementById("subgrupoProd").value = producto.subgrupo || "";
  
  // Imagen
  if (producto.imagen_url) {
    const previewFoto = document.getElementById("previewFoto");
    previewFoto.src = producto.imagen_url;
    previewFoto.classList.remove("d-none");
    document.getElementById("btnQuitarFoto").classList.remove("d-none");
  }
  
  // Guardar ID del producto que estamos editando
  window.productoEditandoId = producto.id_base;
  
  // Scroll al formulario
  adminCard.scrollIntoView({ behavior: 'smooth' });
  
  console.log("‚úÖ Producto cargado en formulario para edici√≥n:", producto.nombre);
}

async function obtenerStockCompleto(productoId, email) {
  try {
    const response = await fetch(`${URL_BACKEND}/api/producto/${productoId}/stock?email=${encodeURIComponent(email)}`);
    
    if (!response.ok) {
      throw new Error(`Error HTTP ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.status === 'ok') {
      // Guardar datos en variables globales para acceso r√°pido
      window[`stock_completo_${productoId}`] = data;
      window[`stock_por_talle_${productoId}`] = data.stock.por_talle;
      
      return data;
    } else {
      throw new Error(data.error || 'Error desconocido');
    }
  } catch (error) {
    console.error('‚ùå Error obteniendo stock completo:', error);
    return null;
  }
}

// Funci√≥n unificada para actualizar stock
async function actualizarStockUnificado(productoId, email, tipo, datos) {
  try {
    const payload = {
      email: email,
      tipo: tipo,
      ...datos
    };
    
    const response = await fetch(`${URL_BACKEND}/api/producto/${productoId}/stock/actualizar`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const data = await response.json();
    
    if (data.status === 'ok') {
      mostrarAviso(`‚úÖ Stock ${tipo} actualizado`);
      return data;
    } else {
      throw new Error(data.error || 'Error al actualizar stock');
    }
  } catch (error) {
    console.error('‚ùå Error actualizando stock:', error);
    mostrarAviso(`‚ùå ${error.message}`);
    return null;
  }
}
    
function salirAdmin() {
  console.log("üö™ Saliendo de modo admin, limpiando token...");

  // Desactivar modo admin y limpiar token
  window.modoAdmin = false;
  window.tokenAdmin = null;

  // Limpiar la URL para quitar el ?token=...
  history.replaceState(null, "", "index.html");

  // Refrescar productos para que se oculten los botones ‚úé
  if (window.todosLosProductos) {
    const cont = document.getElementById("productos");
    if (cont) {
      cont.innerHTML = "";
      window.todosLosProductos.forEach(p => cont.appendChild(renderProducto(p)));
      console.log("‚úÖ Productos re-renderizados en modo p√∫blico, total:", cont.children.length);
    } else {
      console.warn("‚ö†Ô∏è No se encontr√≥ el contenedor #productos al salir de admin");
    }
  }

  // Ocultar bot√≥n de logout
  const logoutWrapper = document.getElementById("logoutAdminWrapper");
  if (logoutWrapper) {
    logoutWrapper.style.display = "none";
    console.log("‚úÖ Bot√≥n de logout ocultado");
  } else {
    console.warn("‚ö†Ô∏è No se encontr√≥ #logoutAdminWrapper en el DOM");
  }

  // Ocultar paneles de administraci√≥n
  const adminCard = document.getElementById("adminCard");
  if (adminCard) {
    adminCard.classList.add("d-none");
    console.log("‚úÖ adminCard ocultado");
  }

  const configurarMP = document.getElementById("configurarMP");
  if (configurarMP) {
    configurarMP.classList.add("d-none");
    console.log("‚úÖ configurarMP ocultado");
  }
}

// Mostrar el bot√≥n solo si modoAdmin est√° activo
if (window.modoAdmin) {
  const logoutWrapper = document.getElementById("logoutAdminWrapper");
  if (logoutWrapper) {
    logoutWrapper.style.display = "block";
    console.log("üîë Modo admin activo, mostrando bot√≥n de logout");
  }

  // Mostrar paneles de administraci√≥n
  const adminCard = document.getElementById("adminCard");
  if (adminCard) {
    adminCard.classList.remove("d-none");
    console.log("üîë adminCard mostrado");
  }

  const configurarMP = document.getElementById("configurarMP");
  if (configurarMP) {
    configurarMP.classList.remove("d-none");
    console.log("üîë configurarMP mostrado");
  }
}

function editarStockTalleActual(idProducto) {
  console.log(`‚úèÔ∏è [editarStockTalleActual] Editando stock para producto: ${idProducto}`);
  
  const talleSelect = document.getElementById(`talle_${idProducto}`);
  if (!talleSelect || !talleSelect.value) {
    alert("‚ùå Primero selecciona un talle");
    return;
  }
  
  const talleActual = talleSelect.value;
  const stockSpan = document.getElementById(`stock_${idProducto}`);
  
  if (!stockSpan) {
    console.error("‚ùå No se encontr√≥ el span de stock");
    return;
  }
  
  let valorActual = stockSpan.textContent.trim();
  
  // Convertir "Sin stock" a 0
  if (valorActual === "Sin stock" || valorActual === "sin stock") {
    valorActual = "0";
  }
  
  console.log(`üìù Valor actual de stock para talle ${talleActual}:`, valorActual);

  const input = document.createElement("input");
  input.type = "number";
  input.min = "0";
  input.value = valorActual;
  input.defaultValue = valorActual;
  input.className = "form-control form-control-sm d-inline-block";
  input.style.width = "80px";
  input.id = "input_stock_talle_" + idProducto;
  
  input.dataset.talle = talleActual;
  input.dataset.id_base = idProducto;
  input.dataset.email = email;
  
  input.onblur = () => guardarStockPorTalle(idProducto, talleActual);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      input.blur();
    }
  });
  
  stockSpan.replaceWith(input);
  input.focus();
  input.select();
}

function guardarStockPorTalle(idProducto, talle) {
  const input = document.getElementById("input_stock_talle_" + idProducto);
  if (!input) {
    console.warn("‚ùå No se encontr√≥ el input de stock por talle");
    alert("‚ùå Error interno: No se encontr√≥ el campo de stock");
    return;
  }
  
  const nuevoStock = parseInt(input.value) || 0;
  
  if (nuevoStock < 0) {
    alert("‚ùå El stock no puede ser negativo");
    input.value = "0";
    return;
  }
  
  console.log("üì° [guardarStockPorTalle] Enviando al backend:", { 
    id: idProducto, 
    talle: talle,
    stock: nuevoStock,
    email: email
  });
  
  if (!email || email === "") {
    alert("‚ùå Error: No se detect√≥ el email del vendedor. Recarga la p√°gina.");
    console.error("üí• email est√° vac√≠o:", email);
    return;
  }
  
  // Enviar al backend
  fetch(`${URL_BACKEND}/actualizar-stock-talle`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ 
      id: idProducto,
      talle: talle,
      stock: nuevoStock,
      email: email
    })
  })
  .then(res => {
    console.log("üì° Respuesta HTTP recibida, status:", res.status);
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    return res.json();
  })
  .then(data => {
    console.log("üì© Respuesta backend actualizar-stock-talle:", data);
    
    if (data.status === "ok") {
      // 1. Actualizar en la UI
      const span = document.createElement("span");
      span.id = `stock_${idProducto}`;
      span.textContent = nuevoStock > 0 ? nuevoStock : "Sin stock";
      span.className = nuevoStock > 0 ? "" : "text-danger";
      input.replaceWith(span);
      
      // 2. Actualizar la variable local stock_por_talle
      if (!window[`stock_por_talle_${idProducto}`]) {
        window[`stock_por_talle_${idProducto}`] = {};
      }
      window[`stock_por_talle_${idProducto}`][talle] = nuevoStock;
      
      // 3. Actualizar controles de cantidad
      const cantidadInput = document.getElementById(`cantidad_${idProducto}`);
      const agregarBtn = document.getElementById(`btn_agregar_${idProducto}`);
      
      if (cantidadInput && agregarBtn) {
        if (nuevoStock > 0) {
          cantidadInput.max = nuevoStock;
          cantidadInput.disabled = false;
          const valorActual = parseInt(cantidadInput.value) || 1;
          cantidadInput.value = Math.min(valorActual, nuevoStock);
          agregarBtn.disabled = false;
          agregarBtn.style.opacity = "1";
          agregarBtn.textContent = "Agregar al carrito";
        } else {
          cantidadInput.disabled = true;
          cantidadInput.value = "0";
          agregarBtn.disabled = true;
          agregarBtn.style.opacity = "0.5";
          agregarBtn.textContent = "Sin stock";
        }
      }
      
      // 4. Mostrar aviso
      mostrarAvisoStock();
      console.log(`‚úÖ Stock actualizado para talle ${talle}: ${nuevoStock}`);
      
    } else {
      console.error("‚ùå Error en respuesta backend:", data);
      alert("‚ùå No se pudo actualizar el stock: " + (data.message || data.error));
      
      // Revertir
      const span = document.createElement("span");
      span.id = `stock_${idProducto}`;
      span.textContent = input.defaultValue || "0";
      span.className = "text-danger";
      input.replaceWith(span);
    }
  })
  .catch(err => {
    console.error("üí• Error de conexi√≥n en guardarStockPorTalle:", err);
    alert("‚ùå Error de conexi√≥n al guardar el stock");
    
    // Revertir
    const span = document.createElement("span");
    span.id = `stock_${idProducto}`;
    span.textContent = input.defaultValue || "0";
    span.className = "text-danger";
    input.replaceWith(span);
  });
}

function editarTallesYStock(idProducto) {
  console.log(`üéõÔ∏è [editarTallesYStock] Abriendo editor para producto: ${idProducto}`);
  
  // Obtener los talles y stocks actuales
  let stockPorTalle = window[`stock_por_talle_${idProducto}`] || {};
  let tallesActuales = Object.keys(stockPorTalle);
  
  // Si no hay stock_por_talle, intentar obtener de talles array
  if (tallesActuales.length === 0) {
    // Buscar el producto en la lista para obtener talles
    const producto = window.todosLosProductos?.find(p => p.id_base === idProducto);
    if (producto && Array.isArray(producto.talles)) {
      tallesActuales = producto.talles;
      // Inicializar stock en 0 para cada talle
      tallesActuales.forEach(talle => {
        stockPorTalle[talle] = producto.stock || 0;
      });
    }
  }
  
  // Crear modal
  const modalHTML = `
    <div class="modal fade" id="modalTallesStock" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">üìè Gesti√≥n de Talles y Stock</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <h6>Talles actuales:</h6>
              <div id="listaTallesStock" class="mb-3">
                ${tallesActuales.map((talle, index) => `
                  <div class="row g-2 align-items-center mb-2">
                    <div class="col-md-4">
                      <input type="text" class="form-control form-control-sm talle-input" 
                             value="${talle}" data-index="${index}"
                             placeholder="Talle (ej: S, M, L)">
                    </div>
                    <div class="col-md-4">
                      <input type="number" class="form-control form-control-sm stock-input" 
                             value="${stockPorTalle[talle] || 0}" data-index="${index}" min="0"
                             placeholder="Stock">
                    </div>
                    <div class="col-md-4">
                      <button type="button" class="btn btn-sm btn-danger" 
                              onclick="eliminarFilaTalle(${index})">
                        üóëÔ∏è Eliminar
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
              
              <button type="button" class="btn btn-sm btn-success" onclick="agregarFilaTalle()">
                ‚ûï Agregar talle
              </button>
            </div>
            
            <hr>
            
            <div class="d-grid gap-2">
              <button type="button" class="btn btn-primary" 
                      onclick="guardarTallesYStock('${idProducto}')">
                üíæ Guardar cambios
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // A√±adir modal al DOM si no existe
  if (!document.getElementById('modalTallesStock')) {
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  // Mostrar modal
  const modal = new bootstrap.Modal(document.getElementById('modalTallesStock'));
  modal.show();
}

// Funciones auxiliares para el modal
function agregarFilaTalle() {
  const lista = document.getElementById('listaTallesStock');
  if (!lista) return;
  
  const index = lista.querySelectorAll('.row').length;
  
  const nuevaFila = `
    <div class="row g-2 align-items-center mb-2">
      <div class="col-md-4">
        <input type="text" class="form-control form-control-sm talle-input" 
               value="" data-index="${index}"
               placeholder="Talle (ej: S, M, L)">
      </div>
      <div class="col-md-4">
        <input type="number" class="form-control form-control-sm stock-input" 
               value="0" data-index="${index}" min="0"
               placeholder="Stock">
      </div>
      <div class="col-md-4">
        <button type="button" class="btn btn-sm btn-danger" 
                onclick="eliminarFilaTalle(${index})">
          üóëÔ∏è Eliminar
        </button>
      </div>
    </div>
  `;
  
  lista.insertAdjacentHTML('beforeend', nuevaFila);
}

function eliminarFilaTalle(index) {
  const fila = document.querySelector(`[data-index="${index}"]`)?.closest('.row');
  if (fila) {
    fila.remove();
  }
}

function guardarTallesYStock(idProducto) {
  console.log(`üíæ [guardarTallesYStock] Guardando para producto: ${idProducto}`);
  
  const talleInputs = document.querySelectorAll('.talle-input');
  const stockInputs = document.querySelectorAll('.stock-input');
  
  const stockPorTalle = {};
  let hayErrores = false;
  
  // Validar y recopilar datos
  talleInputs.forEach((input, index) => {
    const talle = input.value.trim();
    const stock = parseInt(stockInputs[index]?.value) || 0;
    
    if (talle === "") {
      alert(`‚ùå El talle en la fila ${index + 1} est√° vac√≠o`);
      hayErrores = true;
      return;
    }
    
    if (stockPorTalle[talle] !== undefined) {
      alert(`‚ùå El talle "${talle}" est√° duplicado`);
      hayErrores = true;
      return;
    }
    
    stockPorTalle[talle] = stock;
  });
  
  if (hayErrores) return;
  
  console.log("üì¶ Datos a guardar:", { idProducto, stockPorTalle, email });
  
  // üî• Enviar SOLO stock_por_talle al backend
  fetch(`${URL_BACKEND}/guardar-talles-stock`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ 
      id: idProducto,
      stock_por_talle: stockPorTalle,
      email: email
    })
  })
  .then(res => res.json())
  .then(data => {
    console.log("üì© Respuesta backend:", data);
    
    if (data.status === "ok") {
      // 1. Cerrar modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalTallesStock'));
      if (modal) modal.hide();
      
      // 2. Actualizar variable local
      window[`stock_por_talle_${idProducto}`] = stockPorTalle;
      
      // 3. Actualizar select de talles en la card
      const talleSelect = document.getElementById(`talle_${idProducto}`);
      if (talleSelect) {
        const opciones = Object.keys(stockPorTalle).map(talle => {
          const stock = stockPorTalle[talle];
          return `<option value="${talle}">${talle} (${stock} disponible${stock > 1 ? 's' : ''})</option>`;
        }).join('');
        
        talleSelect.innerHTML = '<option value="">Seleccionar talle...</option>' + opciones;
        
        // Actualizar stock del primer talle
        const primerTalle = Object.keys(stockPorTalle)[0];
        if (primerTalle) {
          talleSelect.value = primerTalle;
          actualizarStockPorTalle(idProducto, primerTalle);
        }
      }
      
      // 4. Mostrar aviso
      mostrarAviso("‚úÖ Talles y stock guardados correctamente");
      
    } else {
      alert("‚ùå Error al guardar: " + (data.error || "Error desconocido"));
    }
  })
  .catch(err => {
    console.error("üí• Error de conexi√≥n:", err);
    alert("‚ùå Error de conexi√≥n al guardar los datos");
  });
}
    
function renderPagina(pagina, productosFiltrados) {
  const cont = document.getElementById("productos"); // üëà agregar esto
  totalPaginas = Math.ceil(productosFiltrados.length / itemsPorPagina);

  const inicio = (pagina - 1) * itemsPorPagina;
  const fin = inicio + itemsPorPagina;
  const productosPagina = productosFiltrados.slice(inicio, fin);

  cont.innerHTML = "";
  productosPagina.forEach(p => cont.appendChild(renderProducto(p)));
}


function renderPaginacion(productosFiltrados) {
  const pagDiv = document.getElementById("paginacion");
  pagDiv.innerHTML = "";
  totalPaginas = Math.ceil(productosFiltrados.length / itemsPorPagina);

  for (let i = 1; i <= totalPaginas; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.className = "btn btn-light mx-1";
    btn.onclick = () => renderPagina(i, productosFiltrados);
    pagDiv.appendChild(btn);
  }
}

// const EMAIL_VENDEDOR = urlParams.get("usuario") || "usuario@ejemplo.com";
let urlProductos = `https://mpagina.onrender.com/api/productos?usuario=${encodeURIComponent(email)}`;
// Si est√°s en modo admin y ten√©s token, lo incluimos
if (window.modoAdmin && window.tokenAdmin) {
  urlProductos += `&token=${encodeURIComponent(window.tokenAdmin)}`;
}

console.log("üì° Solicitando productos desde:", urlProductos);

fetch(urlProductos)
  .then(r => {
    if (!r.ok) {
      throw new Error("HTTP " + r.status);
    }
    return r.json();
  })
  .then(lista => {
    window.todosLosProductos = Array.isArray(lista) ? lista : [];
    console.log("üåê Productos recibidos de la API:", window.todosLosProductos.length, window.todosLosProductos);

    const cont = document.getElementById("productos");
    const contGrupos = document.getElementById("panelGrupos");
    const contSub = document.getElementById("panelSubcategorias");

    if (!cont) {
      console.warn("‚ö†Ô∏è No existe #productos en el DOM");
      return;
    }
    if (!contGrupos || !contSub) {
      console.warn("‚ö†Ô∏è Faltan paneles #panelGrupos o #panelSubcategorias en el DOM");
    }

    const grupos = [...new Set(window.todosLosProductos.map(p => p.grupo).filter(Boolean))];
    console.log("üìÇ Grupos detectados:", grupos);

    if (contGrupos) {
      contGrupos.innerHTML = ""; // limpiar antes de insertar
      grupos.forEach(g => {
        const btn = document.createElement("button");
        btn.className = "btn-grupo";
        btn.textContent = g;
        btn.addEventListener("click", (e) => {
          console.log("üü¢ Click en bot√≥n grupo:", g);
          mostrarGrupo(g, e);
        });
        contGrupos.appendChild(btn);
        console.log("‚ûï Bot√≥n grupo creado:", g);
      });
    }

    // Render inicial: primer grupo y subgrupo
    const primerGrupo = grupos[0];
    const subgruposPrimer = [...new Set(window.todosLosProductos
      .filter(p => p.grupo === primerGrupo)
      .map(p => p.subgrupo).filter(Boolean))];

    console.log("üéØ Primer grupo:", primerGrupo);
    console.log("üìÇ Subgrupos del primer grupo:", subgruposPrimer);

    if (primerGrupo) {
      mostrarGrupo(primerGrupo, null, true);
      if (subgruposPrimer.length > 0) {
        console.log("‚û°Ô∏è Render inicial con subgrupo:", subgruposPrimer[0]);
        filtrarSubcategoria(primerGrupo, subgruposPrimer[0]);
      }
    }

    console.log("‚úÖ Render inicial completado");
  })
  .catch(err => {
    console.error("üí• Error cargando productos:", err);
    const cont = document.getElementById("productos");
    if (cont) cont.innerHTML = "<p>Error al cargar productos.</p>";
  });
    
function mostrarGrupo(nombre, event, auto = false) {
  console.log("üü¶ mostrarGrupo llamado con:", { nombre, auto });

  const cont = document.getElementById("productos");
  if (!cont) {
    console.warn("‚ö†Ô∏è No existe #productos en el DOM");
    return;
  }

  // Resetear botones de grupo
  document.querySelectorAll('.btn-grupo').forEach(btn => btn.classList.remove('active'));
  if (event?.target) {
    event.target.classList.add('active');
    console.log("üëâ Bot√≥n de grupo marcado:", event.target.textContent);
  }

  const panel = document.getElementById('panelSubcategorias');
  if (!panel) {
    console.warn("‚ö†Ô∏è No existe #panelSubcategorias en el DOM");
    return;
  }
  panel.innerHTML = "";

  // Normalizar y guardar grupo activo
  const grupoCanon = String(nombre || "").trim();
  window.currentGrupo = grupoCanon.toLowerCase();
  console.log("üéØ Grupo activo (canon):", grupoCanon);

  const productosGrupo = (window.todosLosProductos || []).filter(
    p => String(p.grupo || "").toLowerCase() === grupoCanon.toLowerCase()
  );
  console.log("üì¶ Productos encontrados para grupo:", productosGrupo.length);

  const subcategorias = [...new Set(
    productosGrupo.map(p => p.subgrupo).filter(s => s && String(s).toLowerCase() !== 'general')
  )];
  console.log("üìÇ Subcategor√≠as detectadas:", subcategorias);

  // Crear botones de subgrupo
  subcategorias.forEach(sub => {
    const btn = document.createElement('button');
    btn.textContent = sub;
    btn.className = 'btn-subgrupo';
    btn.addEventListener("click", (e) => mostrarSubgrupo(sub, e));
    panel.appendChild(btn);
    console.log("‚ûï Bot√≥n subgrupo creado:", sub);
  });

  // üîÅ Usar paginaci√≥n en lugar de volcar todo
  renderPagina(1, productosGrupo);
  renderPaginacion(productosGrupo);

  if (subcategorias.length > 0) {
    if (!auto) {
      panel.classList.remove('oculta');
      console.log("üìÇ Panel subcategorias visible");
    } else {
      panel.classList.add('oculta');
      console.log("üìÇ Panel subcategorias oculto (auto)");
    }
  } else {
    panel.classList.add('oculta');
    console.log("üìÇ Grupo sin subcategor√≠as");
  }

  console.log("‚úÖ Productos renderizados con paginaci√≥n en #productos");
  window.scrollTo({ top: 0, behavior: 'auto' });
}
window.mostrarGrupo = mostrarGrupo;

// Extra: log de clicks en botones
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("btn-grupo")) {
    console.log("üü¢ Click en bot√≥n grupo:", e.target.textContent);
  }
  if (e.target.classList.contains("btn-subgrupo")) {
    console.log("üü¢ Click en bot√≥n subgrupo:", e.target.textContent);
  }
});

function filtrarSubcategoria(grupo, subgrupo) {
  console.log("üü® filtrarSubcategoria llamada con:", { grupo, subgrupo });

  const cont = document.getElementById("productos");
  if (!cont) {
    console.warn("‚ö†Ô∏è No existe #productos en el DOM");
    return;
  }
  cont.innerHTML = "";

  const grupoCanon = String(grupo || "").trim();
  const subCanon = String(subgrupo || "").trim();
  console.log("üéØ Grupo canon:", grupoCanon, " | Subgrupo canon:", subCanon || `General_${grupoCanon}`);

  // Filtrar productos
  let productosFiltrados;
  if (subCanon) {
    productosFiltrados = window.todosLosProductos.filter(p =>
      String(p.grupo || "").toLowerCase() === grupoCanon.toLowerCase() &&
      String(p.subgrupo || "").toLowerCase() === subCanon.toLowerCase()
    );
  } else {
    const subgrupoGeneral = `General_${grupoCanon}`;
    productosFiltrados = window.todosLosProductos.filter(p =>
      String(p.grupo || "").toLowerCase() === grupoCanon.toLowerCase() &&
      String(p.subgrupo || "").toLowerCase() === subgrupoGeneral.toLowerCase()
    );
  }

  console.log("üì¶ Productos filtrados:", productosFiltrados.length);

  // üîÅ Usar paginaci√≥n en lugar de volcar todo
  renderPagina(1, productosFiltrados);
  renderPaginacion(productosFiltrados);

  console.log("‚úÖ Productos renderizados con paginaci√≥n en #productos");
  console.log("üì• Hijos actuales en #productos:", cont.children.length);

  window.scrollTo({ top: 0, behavior: 'auto' });
}
window.filtrarSubcategoria = filtrarSubcategoria;


window.onload = function() {
  const panelSubcategorias = document.getElementById('panelSubcategorias');
  const panelGrupos = document.getElementById('panelGrupos');
  panelSubcategorias.classList.add('oculta');
  panelGrupos.classList.add('oculta');

  document.getElementById('toggleCarrito').onclick = function() {
    const carritoDiv = document.getElementById('carrito');
    if (!carritoDiv) return;
    carritoDiv.style.display = carritoDiv.style.display === 'none' ? 'block' : 'none';
  };
};

let carrito = [];

function agregarAlCarritoDOM(nombre, idPrecioSpan, idCantidad, id_base, grupo = "", subgrupo = "") {
  const cantidadInput = document.getElementById(idCantidad);
  const precioSpan = document.getElementById(idPrecioSpan);
  const talleSelect = document.getElementById(`talle_${id_base}`);
  
  if (!cantidadInput || !precioSpan) {
    alert("‚ùå Error: No se pudieron obtener los datos del producto");
    return;
  }
  
  // üî• OBTENER TALLE (obligatorio si el producto tiene talles)
  const talleElegido = talleSelect?.value || "unico";
  
  // Verificar stock para el talle seleccionado
  let stockDisponible = 0;
  const stockPorTalle = window[`stock_por_talle_${id_base}`];
  
  if (stockPorTalle) {
    stockDisponible = stockPorTalle[talleElegido] || 0;
  }
  
  if (stockDisponible <= 0) {
    alert("‚ùå No hay stock disponible" + (talleElegido !== "unico" ? ` para el talle ${talleElegido}` : ""));
    return;
  }
  
  const cantidad = parseInt(cantidadInput.value) || 1;
  
  if (cantidad > stockDisponible) {
    alert(`‚ùå Solo hay ${stockDisponible} unidades disponibles${talleElegido !== "unico" ? ` para el talle ${talleElegido}` : ""}`);
    cantidadInput.value = stockDisponible;
    return;
  }
  
  const precio = parseFloat(precioSpan.textContent.replace("$", "").replace(",", "")) || 0;
  
  // Buscar si ya existe en el carrito (mismo producto y mismo talle)
  const existente = carrito.find(item => 
    item.id_base === id_base && 
    item.talle === talleElegido
  );
  
  if (existente) {
    const nuevoTotal = existente.cantidad + cantidad;
    
    if (nuevoTotal > stockDisponible) {
      alert(`‚ùå No puedes llevar m√°s de ${stockDisponible} unidades${talleElegido !== "unico" ? ` del talle ${talleElegido}` : ""}`);
      return;
    }
    
    existente.cantidad = nuevoTotal;
  } else {
    const nuevoItem = { 
      nombre, 
      precio, 
      cantidad, 
      id_base, 
      talle: talleElegido,
      grupo, 
      subgrupo 
    };
    carrito.push(nuevoItem);
  }
  
  actualizarCarrito();
  console.log(`‚úÖ Producto agregado al carrito: ${nombre} ${talleElegido !== "unico" ? `(Talle: ${talleElegido})` : ""}`);
}

function editarPrecio(id) {
  const span = document.getElementById("precio_" + id);
  if (!span) return;

  const valorActual = span.textContent.replace("$", "").trim();

  const input = document.createElement("input");
  input.type = "number";
  input.value = valorActual;
  input.className = "form-control form-control-sm d-inline-block";
  input.style.width = "80px";
  input.id = "input_precio_" + id;

  input.onblur = () => guardarPrecio(id);

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") input.blur(); // dispara onblur
  });

  span.replaceWith(input);
  input.focus();
}

function guardarPrecio(id) {
  const input = document.getElementById("input_precio_" + id);
  if (!input) {
    console.warn("‚ùå No se encontr√≥ el input de precio:", "input_precio_" + id);
    return;
  }

  const nuevoValor = parseFloat(input.value);
  if (isNaN(nuevoValor)) {
    console.error("‚ö†Ô∏è Valor ingresado no es un n√∫mero v√°lido:", input.value);
    alert("‚ùå El precio ingresado no es v√°lido");
    return;
  }

  // üëâ Usa la misma variable global 'email' que en guardarTalles
  console.log("üì° Enviando precio al backend:", { id, nuevoPrecio: nuevoValor, email });

  fetch("https://mpagina.onrender.com/actualizar-precio", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id, nuevoPrecio: nuevoValor, email }) // üëà email incluido igual que en talles
  })
    .then(res => {
      console.log("üì° Respuesta recibida del backend, status:", res.status);
      return res.json();
    })
    .then(data => {
      console.log("üì© Respuesta backend guardarPrecio:", data);

      if (data.status === "ok") {
        const span = document.createElement("span");
        span.id = "precio_" + id;
        const fmt = new Intl.NumberFormat("es-AR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        span.textContent = "$" + fmt.format(nuevoValor);
        span.className = input.className;
        span.classList.add("text-success");
        input.replaceWith(span);
        setTimeout(() => span.classList.remove("text-success"), 1000);

        if (typeof mostrarAvisoPrecio === "function") mostrarAvisoPrecio();
        console.log("‚úÖ Precio actualizado en DOM para producto:", id);
      } else {
        console.error("‚ùå Error en respuesta del backend:", data);
        alert("‚ùå No se pudo actualizar el precio en el servidor");
      }
    })
    .catch(err => {
      console.error("üí• Error de red al actualizar precio:", err);
      alert("‚ùå Error de conexi√≥n al guardar el precio");
    });
}

function loginAdmin(event) {
  event.preventDefault();

  const usuario = document.getElementById("usuario_login").value.trim();
  const clave = document.getElementById("clave_login").value.trim();

  if (!usuario || !clave) {
    alert("‚ùå Usuario y clave requeridos");
    return;
  }

  const btn = event.target.querySelector('button[type="submit"]');
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'Entrando...';
  }

  fetch("https://mpagina.onrender.com/login-admin", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ usuario, clave })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok" && data.token) {
        alert("‚úÖ Acceso concedido");
        // redirigir al preview din√°mico con token en la URL
        location.href = `index.html?token=${data.token}`;
      } else {
        alert("‚ùå " + data.message);
      }
    })
    .catch(() => {
      alert("‚ùå Error al intentar login");
    })
    .finally(() => {
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Entrar';
      }
    });
}
    
function editarTalles(id) {
  const select = document.getElementById("talle_" + id);
  if (!select) return;

  const opciones = Array.from(select.options).map(opt => opt.value).filter(Boolean);
  const valorActual = opciones.join(", ");

  const input = document.createElement("input");
  input.type = "text";
  input.value = valorActual;
  input.className = "form-control form-control-sm d-inline-block";
  input.style.width = "200px";
  input.id = "input_talles_" + id;

  input.onblur = () => guardarTalles(id);
  input.addEventListener("keydown", (e) => { if (e.key === "Enter") input.blur(); });

  select.replaceWith(input);
  input.focus();
}

function guardarTalles(id) {
  const input = document.getElementById("input_talles_" + id);
  if (!input) {
    console.warn("‚ùå No se encontr√≥ el input de talles:", "input_talles_" + id);
    return;
  }

  // Parsear "S, M, L" ‚Üí ["S","M","L"]
  const nuevosTalles = input.value.split(",").map(t => t.trim()).filter(t => t);
  console.log("üì° Enviando talles al backend:", { id, talles: nuevosTalles, email });

  fetch("https://mpagina.onrender.com/actualizar-talles", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id, talles: nuevosTalles, email }) // üëà email incluido
  })
    .then(res => {
      console.log("üì° Respuesta recibida del backend, status:", res.status);
      return res.json();
    })
    .then(data => {
      console.log("üì© Respuesta backend guardarTalles:", data);

      if (data.status === "ok") {
        // Regenerar el select con las nuevas opciones
        const nuevoSelect = document.createElement("select");
        nuevoSelect.id = "talle_" + id;
        nuevoSelect.className = "form-select form-select-sm w-auto d-inline-block";

        if (nuevosTalles.length > 0) {
          nuevosTalles.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            nuevoSelect.appendChild(opt);
          });
        } else {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Sin talles";
          nuevoSelect.appendChild(opt);
        }

        input.replaceWith(nuevoSelect);
        nuevoSelect.classList.add("text-success");
        setTimeout(() => nuevoSelect.classList.remove("text-success"), 1000);

        if (typeof mostrarAvisoTalle === "function") mostrarAvisoTalle();
        console.log("‚úÖ Talles actualizados y DOM refrescado para producto:", id);
      } else {
        console.error("‚ùå Error al actualizar talles:", data.message || data);
        alert("‚ùå No se pudo actualizar los talles en el servidor");
      }
    })
    .catch(err => {
      console.error("üí• Error de conexi√≥n al guardar los talles:", err);
      alert("‚ùå Error de conexi√≥n al guardar los talles");
    });
}

function actualizarFirestore(id, datos) {
  if (!id || typeof datos !== "object" || Object.keys(datos).length === 0) {
    console.warn("‚ö†Ô∏è actualizarFirestore llamado con datos inv√°lidos:", { id, datos });
    return;
  }

  // üîë Usamos directamente el email en vez del token
  console.log("üì° Enviando actualizaci√≥n a Firestore:", { id, datos, email });

  fetch("https://mpagina.onrender.com/actualizar-firestore", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id, ...datos, email }) // üëà email incluido
  })
    .then(res => {
      console.log("üì° Respuesta recibida del backend, status:", res.status);
      return res.json();
    })
    .then(data => {
      console.log("üì© Respuesta backend actualizarFirestore:", data);

      if (data.status === "ok") {
        if (typeof mostrarAvisoFirestore === "function") mostrarAvisoFirestore();
        console.log("‚úÖ Firestore actualizado correctamente para id:", id);
      } else {
        console.error("‚ùå Error al actualizar Firestore:", data.error || data);
        mostrarAviso("‚ùå " + (data.error || "No se pudo actualizar Firestore"));
      }
    })
    .catch(err => {
      console.error("üí• Error de conexi√≥n al guardar los datos:", err);
      mostrarAviso("‚ùå Error de conexi√≥n al guardar los datos");
    });
}

function guardarProducto(producto) {
  console.log("üì° [guardarProducto] Enviando producto al backend:", { producto, email });

  fetch("https://mpagina.onrender.com/guardar-producto", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ producto, email })
  })
    .then(res => {
      console.log("üì° [guardarProducto] Respuesta recibida del backend, status:", res.status);
      return res.json().catch(err => {
        console.error("üí• [guardarProducto] Error parseando JSON:", err);
        throw new Error("Respuesta no es JSON v√°lido");
      });
    })
    .then(data => {
      window.lastResponse = data; // üëâ inspecci√≥n manual en consola

      console.log("üì© [guardarProducto] JSON recibido (objeto):", data);
      console.log("üì© [guardarProducto] JSON recibido (string):", JSON.stringify(data, null, 2));

      // ‚úÖ √©xito si backend devuelve {status:"ok"} o {ok:true}
      if (data.status === "ok" || Boolean(data.ok)) {
        console.log("‚úÖ [guardarProducto] √âxito detectado:", data);
        mostrarAviso("‚úÖ Producto guardado correctamente");

        if (typeof cargarProductos === "function") {
          console.log("üîÑ [guardarProducto] Refrescando cat√°logo...");
          cargarProductos();
        } else {
          console.warn("‚ö†Ô∏è [guardarProducto] cargarProductos no est√° definido");
        }
      } else {
        const errorMsg = data.error || JSON.stringify(data);
        console.error("‚ùå [guardarProducto] Error en respuesta backend:", errorMsg);
        mostrarAviso("‚ùå " + errorMsg);
      }
    })
    .catch(err => {
      console.error("üí• [guardarProducto] Error de conexi√≥n o flujo:", err);
      mostrarAviso("‚ùå Error de conexi√≥n al guardar producto");
    });
}

function cargarProductos(emailUsuario = null) {
  // Construir URL base
  let url = "https://mpagina.onrender.com/api/productos";

  // Si se pasa un email expl√≠cito, lo agregamos
  if (emailUsuario) {
    url += "?usuario=" + encodeURIComponent(emailUsuario);
  } else {
    // Si no, usar el EMAIL_VENDEDOR global
    url += "?usuario=" + encodeURIComponent(window.email || "usuario@ejemplo.com");
  }

  // Si estamos en modo admin y hay token, lo incluimos
  if (window.modoAdmin && window.tokenAdmin) {
    url += `&token=${encodeURIComponent(window.tokenAdmin)}`;
  }

  console.log("üì° Solicitando productos desde:", url);

  fetch(url)
    .then(res => {
      console.log("üì° Respuesta recibida del backend, status:", res.status);
      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }
      return res.json();
    })
    .then(productos => {
      console.log("üì© Datos recibidos de productos:", productos);

      if (Array.isArray(productos)) {
        console.log("‚úÖ Renderizando productos, total:", productos.length);
        renderizarProductos(productos);
      } else if (productos.error) {
        console.error("‚ùå Error en respuesta de productos:", productos.error);
        mostrarAviso("‚ùå " + productos.error);
      } else {
        console.error("‚ùå Respuesta inv√°lida del servidor:", productos);
        mostrarAviso("‚ùå Respuesta inv√°lida del servidor");
      }
    })
    .catch(err => {
      console.error("üí• Error cargando productos:", err);
    });
}

function mostrarAviso(mensaje) {
  // Crear aviso si no existe
  let aviso = document.getElementById("avisoFlotante");
  if (!aviso) {
    aviso = document.createElement("div");
    aviso.id = "avisoFlotante";
    aviso.className = "alert alert-success text-center";
    aviso.role = "alert";
    aviso.style.cssText = `
      display: none;
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      padding: 10px 20px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    `;
    document.body.appendChild(aviso);
  }
  
  aviso.textContent = mensaje;
  aviso.style.display = "block";
  
  setTimeout(() => {
    aviso.style.display = "none";
  }, 3000);
}
    
function mostrarAvisoPrecio() {
  const aviso = document.getElementById("avisoPrecio");
  if (!aviso) return;
  aviso.style.display = "block";
  setTimeout(() => {
    aviso.style.display = "none";
  }, 2000);
}

function eliminarDelCarrito(id_base, talle, event) {
  if (event?.stopPropagation) event.stopPropagation();

  console.log("[CARRITO] ‚ùå Eliminando:", { id_base, talle });

  carrito = carrito.filter(p => {
    if (talle && talle !== "unico") {
      return !(p.id_base === id_base && p.talle === talle);
    } else {
      return p.id_base !== id_base;
    }
  });

  actualizarCarrito();
}
    
function mostrarSubgrupo(subgrupo, event) {
  console.log("üü© mostrarSubgrupo llamada con:", subgrupo);

  // Buscar el grupo actualmente activo (bot√≥n marcado)
  const grupoActivoBtn = document.querySelector('.btn-grupo.active');
  const grupoActivo = grupoActivoBtn ? grupoActivoBtn.textContent.trim() : null;
  console.log("üéØ Grupo activo detectado:", grupoActivo);

  if (!grupoActivo) {
    console.warn("‚ö†Ô∏è No hay grupo activo para mostrar subgrupo:", subgrupo);
    return;
  }

  // Resetear botones de subgrupo
  document.querySelectorAll('.btn-subgrupo').forEach(btn => btn.classList.remove('active'));
  if (event?.target) {
    event.target.classList.add('active');
    console.log("üëâ Bot√≥n subgrupo marcado:", event.target.textContent);
  }

  // Actualizar estado can√≥nico
  const grupoCanon = String(grupoActivo).trim();
  const subCanon = String(subgrupo || "").trim();

  window.currentGrupo = grupoCanon.toLowerCase();
  window.currentSub = subCanon.toLowerCase();
  console.log("üìå Estado can√≥nico actualizado:", { currentGrupo: window.currentGrupo, currentSub: window.currentSub });

  // Filtrar y renderizar productos del grupo + subgrupo
  console.log("‚û°Ô∏è Llamando a filtrarSubcategoria con:", { grupoCanon, subCanon });
  filtrarSubcategoria(grupoCanon, subCanon);

  // Logs extra para verificar DOM y estilos
  const cont = document.getElementById("productos");
  if (cont) {
    console.log("üì• Hijos actuales en #productos despu√©s de mostrarSubgrupo:", cont.children.length);
    console.log("üß© HTML actual de #productos:", cont.innerHTML.slice(0, 300) + "...");
    const style = window.getComputedStyle(cont);
    console.log("üëÅÔ∏è Estilo de #productos:", { display: style.display, visibility: style.visibility });
  }
}
window.mostrarSubgrupo = mostrarSubgrupo;

// Extra: log de clicks en botones de subgrupo
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("btn-subgrupo")) {
    console.log("üü¢ Click detectado en bot√≥n subgrupo:", e.target.textContent);
  }
});

function actualizarPrecioEnCarrito(nombre, nuevoPrecio) {
  let cambio = false;
  carrito.forEach(item => {
    if (item.nombre === nombre && item.precio !== nuevoPrecio) {
      item.precio = nuevoPrecio;
      cambio = true;
    }
  });
  if (cambio) actualizarCarrito();
}

function sincronizarPreciosDelCarrito() {
  carrito.forEach(item => {
    const idPrecio = "precio_" + (item.id_base || item.nombre.replace(/ /g, "_"));
    const precioSpan = document.getElementById(idPrecio);
    if (precioSpan) {
      const precioActual = parseFloat(precioSpan.textContent);
      if (!isNaN(precioActual)) {
        item.precio = precioActual;
      }
    }
  });
}

function actualizarCarrito() {
  sincronizarPreciosDelCarrito();

  const lista = document.getElementById('listaCarrito');
  const totalSpan = document.getElementById('totalCarrito');
  if (!lista || !totalSpan) return;

  lista.innerHTML = '';
  let suma = 0;

  if (carrito.length === 0) {
    lista.innerHTML = "<li>üõí Carrito vac√≠o</li>";
    totalSpan.textContent = "0.00";
    return;
  }

  const fmt = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  carrito.forEach(item => {
    const subtotal = item.precio * item.cantidad;
    suma += subtotal;

    // Crear descripci√≥n con talle y color
    let descripcion = item.nombre;
    if (item.talle) descripcion += ` (Talle: ${item.talle})`;
    if (item.color) descripcion += ` (Color: ${item.color})`;

    lista.insertAdjacentHTML("beforeend", `
      <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <div>
          <div><strong>${descripcion}</strong></div>
          <div style="font-size: 0.9em; color: #666;">
            ${item.cantidad} x $${item.precio.toFixed(2)} = $${subtotal.toFixed(2)}
          </div>
        </div>
        <button onmousedown="eliminarDelCarrito('${item.id_base}', '${item.talle}', '${item.color}', event)" 
                style="background: none; border: none; color: red; font-weight: bold; font-size: 16px; cursor: pointer;">
          ‚ùå
        </button>
      </li>`);
  });

  totalSpan.textContent = fmt.format(suma);
}

function mostrarTodos() {
  const panelGrupos = document.getElementById('panelGrupos');
  const panelSub = document.getElementById('panelSubcategorias');

  if (!panelGrupos || !panelSub) return;

  panelGrupos.classList.toggle('oculta');

  if (!panelSub.classList.contains('oculta')) {
    panelSub.classList.add('oculta');
  }
}
window.mostrarTodos = mostrarTodos; 
      
function irAContacto() {
  const contacto = document.getElementById('ubicacion');
  if (contacto) contacto.scrollIntoView({ behavior: 'auto' });
}
window.irAContacto = irAContacto; // si us√°s m√≥dulos
    
function renderProducto(p) {
  const card = document.createElement("div");
  card.className = "col-lg-4 col-md-6 col-sm-12 mb-4 fade-reorder card-producto";
  card.dataset.id = p.id_base;
  card.dataset.precio = p.precio;

  // üî• SOLO usar stock_por_talle
  const tieneStockPorTalle = p.stock_por_talle && Object.keys(p.stock_por_talle).length > 0;
  
  let stockData = {};
  let opcionesTalles = "";
  let talleInicial = "";
  let stockInicial = 0;
  
  if (tieneStockPorTalle) {
    // üî• PRIORIDAD √öNICA: Usar stock_por_talle
    stockData = p.stock_por_talle;
    window[`stock_por_talle_${p.id_base}`] = stockData;
    
    // Generar opciones de talles
    const tallesDisponibles = Object.keys(stockData);
    tallesDisponibles.forEach(talle => {
      const stock = stockData[talle] || 0;
      const opcion = stock > 0 ? 
        `<option value="${talle}">${talle} (${stock} disponible${stock > 1 ? 's' : ''})</option>` :
        `<option value="${talle}" disabled>${talle} (Agotado)</option>`;
      opcionesTalles += opcion;
      
      // Si es el primer talle con stock, usarlo como valor inicial
      if (stockInicial === 0 && stock > 0) {
        stockInicial = stock;
        talleInicial = talle;
      }
    });
    
    // Si ning√∫n talle tiene stock, usar el primero disponible
    if (stockInicial === 0 && tallesDisponibles.length > 0) {
      talleInicial = tallesDisponibles[0];
      stockInicial = stockData[talleInicial] || 0;
    }
  } else {
    // üî• Producto sin talles: en este caso podr√≠as usar un stock general
    // Pero vamos a crear un campo stock_por_talle con clave "unico"
    const stockGeneral = p.stock || 0; // Para compatibilidad temporal
    stockData = { "unico": stockGeneral };
    window[`stock_por_talle_${p.id_base}`] = stockData;
    stockInicial = stockGeneral;
  }
  
  const mostrarStock = stockInicial > 0 ? stockInicial : "Sin stock";
  const claseStock = stockInicial > 0 ? "" : "text-danger";

  // Escape de caracteres
  const nombreEscapado = p.nombre.replace(/'/g, "\\'").replace(/"/g, '\\"');
  const descripcionEscapada = (p.descripcion || "").replace(/'/g, "\\'").replace(/"/g, '\\"');
  const imagenUrl = p.imagen_url || '/static/img/fallback.webp';
  const grupoEscapado = (p.grupo || "").replace(/'/g, "\\'");
  const subgrupoEscapado = (p.subgrupo || "").replace(/'/g, "\\'");
  
  const onclickAgregar = `agregarAlCarritoDOM('${nombreEscapado}', 'precio_${p.id_base}', 'cantidad_${p.id_base}', '${p.id_base}', '${grupoEscapado}', '${subgrupoEscapado}')`;
  
  // Mostrar descripci√≥n en la card
  const mostrarDescripcion = p.descripcion ? 
    `<p class="card-text text-light small mb-2">${p.descripcion}</p>` : 
    '';
  
  card.innerHTML = `
    <div class="card p-3 h-100">
      <img src="${imagenUrl}"
           alt="${p.nombre}" loading="lazy"
           style="width:300px;height:180px;object-fit:contain;border-radius:4px;cursor:pointer;"
           onclick="openModal('${imagenUrl}')">
      <div class="card-body">
        <h5 class="card-title">${p.nombre}</h5>
        
        <!-- Descripci√≥n del producto -->
        ${mostrarDescripcion}
        
        <!-- Informaci√≥n de precio -->
        <p class="mb-2">
          <strong>Precio:</strong> 
          $<span id="precio_${p.id_base}">${p.precio}</span>
        </p>
        
        <!-- Selector de talle (SOLO si hay talles) -->
        ${Object.keys(stockData).length > 0 && Object.keys(stockData)[0] !== "unico" ? `
          <div class="mb-2">
            <label class="form-label mb-1" style="font-size: 14px;"><strong>Talle:</strong></label>
            <select id="talle_${p.id_base}" class="form-select form-select-sm w-auto d-inline-block"
                    onchange="actualizarStockPorTalle('${p.id_base}', this.value)">
              <option value="">Seleccionar talle...</option>
              ${opcionesTalles}
            </select>
          </div>
        ` : ""}
        
        <!-- Stock disponible -->
        <p class="mb-2">
          <strong>Disponible:</strong> 
          <span id="stock_${p.id_base}" class="${claseStock}">${mostrarStock}</span>
        </p>
        
        ${configWhatsApp ? `<a href="${configWhatsApp}" class="btn btn-whatsapp">Contactar por WhatsApp</a>` : ""}
        
        <div class="mt-2 d-flex flex-wrap align-items-center gap-2">
          <label class="mb-0" style="font-size: 14px;">Cantidad:</label>
          <input type="number" min="1" max="${stockInicial > 0 ? stockInicial : 1}" value="1"
                 id="cantidad_${p.id_base}"
                 class="form-control form-control-sm" style="width: 70px;"
                 ${stockInicial <= 0 ? "disabled" : ""}>
          
          <button type="button" class="btn btn-secondary" id="btn_agregar_${p.id_base}"
            onclick="${onclickAgregar}"
            ${stockInicial <= 0 ? "disabled style='opacity:0.5'" : ""}>
            ${stockInicial > 0 ? "Agregar al carrito" : "Sin stock"}
          </button>
        </div>
        
        <!-- üî• BOTONES DE ADMIN - SIMPLIFICADO A UN SOLO BOT√ìN DE EDICI√ìN -->
        ${window.modoAdmin ? `
          <div class="mt-3 d-flex flex-wrap gap-2">
            <!-- √öNICO BOT√ìN PARA EDITAR TODO EL PRODUCTO -->
            <button type="button" class="btn btn-warning btn-sm"
              onclick="cargarProductoCompletoParaEditar('${p.id_base}')">
              ‚úèÔ∏è Editar Producto
            </button>
            
            <!-- Bot√≥n eliminar -->
            <button type="button" class="btn btn-danger btn-sm"
              onclick="eliminarProducto('${p.id_base}')">
              üóëÔ∏è Eliminar
            </button>
          </div>
        ` : ""}
      </div>
    </div>
  `;

  // üî• Configurar talle inicial despu√©s de renderizar
  if (talleInicial) {
    setTimeout(() => {
      const talleSelect = document.getElementById(`talle_${p.id_base}`);
      if (talleSelect) {
        talleSelect.value = talleInicial;
        actualizarStockPorTalle(p.id_base, talleInicial);
      }
    }, 100);
  }

  requestAnimationFrame(() => card.classList.add("show"));
  setTimeout(() => card.classList.remove("fade-reorder"), 50);

  return card;
}

// üî• NUEVA FUNCI√ìN: Cargar producto completo para edici√≥n
function cargarProductoCompletoParaEditar(id_base) {
  const producto = window.todosLosProductos?.find(p => p.id_base === id_base);
  if (producto) {
    cargarProductoEnFormulario(producto);
  } else {
    alert("‚ùå No se encontr√≥ el producto para editar");
  }
}

// üî• NUEVA FUNCI√ìN: Editar solo la descripci√≥n
function editarDescripcion(id_base) {
  const spanDescripcion = document.querySelector(`[data-id="${id_base}"] .card-text.text-muted.small.mb-2`);
  const producto = window.todosLosProductos?.find(p => p.id_base === id_base);
  
  if (!producto) {
    alert("‚ùå Producto no encontrado");
    return;
  }
  
  const descripcionActual = producto.descripcion || "";
  
  const input = document.createElement("textarea");
  input.value = descripcionActual;
  input.className = "form-control form-control-sm";
  input.style.width = "100%";
  input.rows = 3;
  input.id = "input_descripcion_" + id_base;
  
  // Reemplazar el p√°rrafo por el textarea
  if (spanDescripcion) {
    spanDescripcion.replaceWith(input);
  } else {
    // Si no existe el elemento de descripci√≥n, insertarlo despu√©s del t√≠tulo
    const cardTitle = document.querySelector(`[data-id="${id_base}"] .card-title`);
    if (cardTitle) {
      cardTitle.after(input);
    }
  }
  
  input.focus();
  
  // Guardar al perder foco
  input.onblur = () => guardarDescripcion(id_base, input.value);
  
  // Guardar con Enter (Ctrl+Enter para nueva l√≠nea)
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.ctrlKey) {
      e.preventDefault();
      input.blur();
    }
  });
}

// üî• NUEVA FUNCI√ìN: Guardar descripci√≥n
function guardarDescripcion(id_base, nuevaDescripcion) {
  const email = obtenerEmailAdmin();
  if (!email) {
    alert("‚ùå No hay email de admin");
    return;
  }
  
  const input = document.getElementById("input_descripcion_" + id_base);
  
  // Actualizar en la variable local
  const productoIndex = window.todosLosProductos?.findIndex(p => p.id_base === id_base);
  if (productoIndex !== -1 && productoIndex !== undefined) {
    window.todosLosProductos[productoIndex].descripcion = nuevaDescripcion;
  }
  
  // Actualizar en Firestore
  fetch("https://mpagina.onrender.com/actualizar-firestore", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ 
      id: id_base,
      email: email,
      descripcion: nuevaDescripcion
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "ok") {
      // Re-crear el elemento de descripci√≥n
      const nuevoParrafo = document.createElement("p");
      nuevoParrafo.className = "card-text text-muted small mb-2";
      nuevoParrafo.textContent = nuevaDescripcion || "";
      
      if (input) {
        input.replaceWith(nuevoParrafo);
      }
      
      // Mostrar aviso
      const aviso = document.createElement("div");
      aviso.className = "alert alert-success alert-dismissible fade show";
      aviso.style.position = "fixed";
      aviso.style.top = "20px";
      aviso.style.right = "20px";
      aviso.style.zIndex = "10000";
      aviso.innerHTML = `
        ‚úÖ Descripci√≥n actualizada
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(aviso);
      setTimeout(() => aviso.remove(), 3000);
    }
  })
  .catch(err => {
    console.error("‚ùå Error al guardar descripci√≥n:", err);
    alert("‚ùå Error al guardar descripci√≥n");
  });
}

// üî• FUNCI√ìN AUXILIAR: Extraer stock de variantes
function extraerStockDeVariantes(variantes) {
  const stockPorTalle = {};
  
  if (!variantes || typeof variantes !== 'object') {
    return stockPorTalle;
  }
  
  Object.values(variantes).forEach(variante => {
    if (variante && variante.talle) {
      const talle = variante.talle.trim();
      if (talle) {
        if (!stockPorTalle[talle]) {
          stockPorTalle[talle] = 0;
        }
        stockPorTalle[talle] += (parseInt(variante.stock) || 0);
      }
    }
  });
  
  return stockPorTalle;
}

// Funci√≥n para cargar las variantes de un producto
async function cargarVariantesProducto(idProducto) {
  try {
    const response = await fetch(`${URL_BACKEND}/api/variantes/${idProducto}`);
    const variantes = await response.json();
    
    if (Array.isArray(variantes)) {
      actualizarSelectoresVariantes(idProducto, variantes);
    }
  } catch (error) {
    console.error("Error cargando variantes:", error);
  }
}

function actualizarStockPorTalle(idProducto, talleSeleccionado) {
  console.log(`üìä [actualizarStockPorTalle] id: ${idProducto}, talle: ${talleSeleccionado}`);
  
  const stockSpan = document.getElementById(`stock_${idProducto}`);
  const cantidadInput = document.getElementById(`cantidad_${idProducto}`);
  const agregarBtn = document.getElementById(`btn_agregar_${idProducto}`);
  
  if (!stockSpan || !cantidadInput || !agregarBtn) {
    console.warn("‚ö†Ô∏è Elementos no encontrados");
    return;
  }
  
  // üî• Obtener stock del talle seleccionado
  let stockDisponible = 0;
  const stockPorTalle = window[`stock_por_talle_${idProducto}`];
  
  if (stockPorTalle && stockPorTalle[talleSeleccionado] !== undefined) {
    stockDisponible = stockPorTalle[talleSeleccionado];
    console.log(`‚úÖ Stock obtenido: ${stockDisponible} para talle ${talleSeleccionado}`);
  } else {
    console.warn(`‚ö†Ô∏è Talle ${talleSeleccionado} no encontrado en stock_por_talle`);
    stockDisponible = 0;
  }
  
  // Actualizar UI
  stockSpan.textContent = stockDisponible > 0 ? stockDisponible : "Sin stock";
  
  if (stockDisponible > 0) {
    stockSpan.classList.remove("text-danger");
    stockSpan.classList.add("text-success");
    setTimeout(() => stockSpan.classList.remove("text-success"), 1000);
    
    cantidadInput.max = stockDisponible;
    cantidadInput.disabled = false;
    const valorActual = parseInt(cantidadInput.value) || 1;
    cantidadInput.value = Math.min(valorActual, stockDisponible);
    
    agregarBtn.disabled = false;
    agregarBtn.style.opacity = "1";
    agregarBtn.textContent = "Agregar al carrito";
  } else {
    stockSpan.classList.remove("text-success");
    stockSpan.classList.add("text-danger");
    
    cantidadInput.disabled = true;
    cantidadInput.value = "0";
    
    agregarBtn.disabled = true;
    agregarBtn.style.opacity = "0.5";
    agregarBtn.textContent = "Sin stock";
  }
  
  console.log(`‚úÖ UI actualizada para talle ${talleSeleccionado}: ${stockDisponible} unidades`);
}

function actualizarUIStock(idProducto, stockDisponible, talleSeleccionado) {
  const stockSpan = document.getElementById(`stock_${idProducto}`);
  const cantidadInput = document.getElementById(`cantidad_${idProducto}`);
  const agregarBtn = document.getElementById(`btn_agregar_${idProducto}`);
  
  // Actualizar el texto del stock
  stockSpan.textContent = stockDisponible > 0 ? stockDisponible : "Sin stock";
  
  // Actualizar clases de estilo
  if (stockDisponible > 0) {
    stockSpan.classList.remove("text-danger");
    stockSpan.classList.add("text-success");
    setTimeout(() => stockSpan.classList.remove("text-success"), 1000);
  } else {
    stockSpan.classList.remove("text-success");
    stockSpan.classList.add("text-danger");
  }
  
  // Actualizar el input de cantidad
  cantidadInput.max = stockDisponible;
  
  if (stockDisponible > 0) {
    cantidadInput.disabled = false;
    const valorActual = parseInt(cantidadInput.value) || 1;
    cantidadInput.value = Math.min(valorActual, stockDisponible);
    
    agregarBtn.disabled = false;
    agregarBtn.style.opacity = "1";
    agregarBtn.textContent = "Agregar al carrito";
  } else {
    cantidadInput.disabled = true;
    cantidadInput.value = "0";
    
    agregarBtn.disabled = true;
    agregarBtn.style.opacity = "0.5";
    agregarBtn.textContent = "Sin stock";
  }
  
  console.log(`‚úÖ Stock actualizado: Talle ${talleSeleccionado} ‚Üí ${stockDisponible} unidades`);
}
    
// Actualizar los selectores de talle/color con las variantes disponibles
function actualizarSelectoresVariantes(idProducto, variantes) {
  const talleSelect = document.getElementById(`talle_${idProducto}`);
  const colorSelect = document.getElementById(`color_${idProducto}`);
  
  if (!talleSelect || !colorSelect) return;
  
  // Obtener talles y colores √∫nicos
  const talles = [...new Set(variantes.map(v => v.talle).filter(Boolean))];
  const colores = [...new Set(variantes.map(v => v.color).filter(Boolean))];
  
  // Limpiar y llenar selectores
  talleSelect.innerHTML = '<option value="">Seleccionar talle...</option>';
  colorSelect.innerHTML = '<option value="">Seleccionar color...</option>';
  
  talles.forEach(talle => {
    const option = document.createElement('option');
    option.value = talle;
    option.textContent = talle;
    talleSelect.appendChild(option);
  });
  
  colores.forEach(color => {
    const option = document.createElement('option');
    option.value = color;
    option.textContent = color;
    colorSelect.appendChild(option);
  });
}

// Actualizar disponibilidad cuando se selecciona talle/color
function actualizarDisponibilidadVariante(idProducto) {
  const talleSelect = document.getElementById(`talle_${idProducto}`);
  const colorSelect = document.getElementById(`color_${idProducto}`);
  const stockDiv = document.getElementById(`stock_variante_${idProducto}`);
  const cantidadSpan = document.getElementById(`cantidad_variante_${idProducto}`);
  const btnAgregar = document.getElementById(`btn_agregar_${idProducto}`);
  const cantidadInput = document.getElementById(`cantidad_${idProducto}`);
  
  const talle = talleSelect.value;
  const color = colorSelect.value;
  
  if (!talle || !color) {
    stockDiv.style.display = 'none';
    btnAgregar.disabled = true;
    btnAgregar.textContent = 'Seleccionar talle y color';
    return;
  }
  
  // Consultar stock espec√≠fico
  fetch(`${URL_BACKEND}/api/productos/${idProducto}/stock-variantes`)
    .then(res => res.json())
    .then(variantes => {
      const variante = variantes.find(v => 
        v.talle === talle && v.color === color
      );
      
      if (variante && variante.stock > 0) {
        stockDiv.style.display = 'block';
        cantidadSpan.textContent = variante.stock;
        btnAgregar.disabled = false;
        btnAgregar.textContent = 'Agregar al carrito';
        
        // Actualizar m√°ximo del input de cantidad
        cantidadInput.max = variante.stock;
        if (parseInt(cantidadInput.value) > variante.stock) {
          cantidadInput.value = variante.stock;
        }
      } else {
        stockDiv.style.display = 'block';
        cantidadSpan.textContent = '0';
        stockDiv.className = 'mb-2 text-danger';
        btnAgregar.disabled = true;
        btnAgregar.textContent = 'Sin stock para esta combinaci√≥n';
      }
    })
    .catch(error => {
      console.error('Error consultando stock:', error);
    });
}
    
// üëâ Funci√≥n que arma el array de items reales desde el carrito
function obtenerCarrito() {
  console.log("üõí [obtenerCarrito] Mapeando carrito a formato MP:");
  
  return carrito.map(item => {
    // Debug: mostrar qu√© datos tenemos
    console.log("  - Item original:", item);
    
    // Asegurar que precio sea n√∫mero
    let precio = item.precio;
    if (typeof precio === 'string') {
      // Remover s√≠mbolo $ y comas, convertir a float
      precio = parseFloat(precio.replace(/[$,]/g, '').trim());
      console.log(`  - Precio convertido de "${item.precio}" a ${precio}`);
    } else if (typeof precio === 'number') {
      console.log(`  - Precio ya es n√∫mero: ${precio}`);
    } else {
      precio = 0;
      console.warn(`  - ‚ö†Ô∏è Precio no v√°lido: ${precio}, usando 0`);
    }
    
    // Asegurar que cantidad sea n√∫mero
    let cantidad = parseInt(item.cantidad) || 1;
    
    const itemFormateado = {
      title: item.nombre + (item.talle ? ` (${item.talle})` : ""),
      quantity: cantidad,
      unit_price: precio,
      id_base: item.id_base,
      grupo: item.grupo || "",
      subgrupo: item.subgrupo || "",
      // üëá MANTENER tambi√©n los campos originales para Firestore
      nombre: item.nombre,
      precio: precio,  // precio convertido a n√∫mero
      cantidad: cantidad,
      talle: item.talle || ""
    };
    
    console.log("  - Item formateado para MP:", itemFormateado);
    return itemFormateado;
  });
}
    
function ajustarPosicionesPaneles() {
  const panelGrupos = document.getElementById('panelGrupos');
  const panelSub = document.getElementById('panelSubcategorias');
  const barraNav = document.querySelector('.barra-navegacion');

  if (!panelGrupos || !panelSub) {
    console.warn("‚ö†Ô∏è No existen paneles en el DOM");
    return;
  }

  console.log("üîß ajustando posiciones de paneles...");

  if (!panelGrupos.classList.contains('oculta')) {
    const alturaBarra = barraNav ? barraNav.offsetHeight : 0;
    panelGrupos.style.top = alturaBarra + 'px';
    panelGrupos.style.position = 'fixed';
    panelGrupos.style.left = '0';
    panelGrupos.style.right = '0';
    console.log("üìê Panel grupos ‚Üí top:", panelGrupos.style.top, "alturaBarra:", alturaBarra);
  }

  if (!panelSub.classList.contains('oculta')) {
    const alturaBarra = barraNav ? barraNav.offsetHeight : 0;
    const alturaGrupos = panelGrupos ? panelGrupos.offsetHeight : 0;
    const margenAdicional = 19;
    const desplazamientoArriba = -20;
    const topCalc = alturaBarra + alturaGrupos + margenAdicional + desplazamientoArriba;
    panelSub.style.top = topCalc + 'px';
    panelSub.style.position = 'fixed';
    panelSub.style.left = '0';
    panelSub.style.right = '0';
    console.log("üìê Panel subcategorias ‚Üí top:", panelSub.style.top, 
                "alturaBarra:", alturaBarra, "alturaGrupos:", alturaGrupos);
  } else {
    panelSub.style.top = '';
    console.log("üìÇ Panel subcategorias oculto");
  }

  // Extra: log de estilos calculados
  const styleGrupos = window.getComputedStyle(panelGrupos);
  const styleSub = window.getComputedStyle(panelSub);
  console.log("üëÅÔ∏è Estilo panelGrupos:", { display: styleGrupos.display, top: styleGrupos.top });
  console.log("üëÅÔ∏è Estilo panelSub:", { display: styleSub.display, top: styleSub.top });
}

////////////////////////////////////////////////////
document.addEventListener("DOMContentLoaded", () => {
  // Ajustar posiciones al cargar y al redimensionar
  window.addEventListener("load", ajustarPosicionesPaneles);
  window.addEventListener("resize", ajustarPosicionesPaneles);

  // Bot√≥n Productos
  const btnProductos = document.getElementById("btnProductos");
  if (btnProductos) {
    btnProductos.addEventListener("click", () => {
      const panelGrupos = document.getElementById("panelGrupos");
      if (panelGrupos) panelGrupos.classList.remove("oculta");
      setTimeout(ajustarPosicionesPaneles, 0);
    });
  }

  // Detectar token admin
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("token");

  if (token) {
    window.modoAdmin = true;
    window.tokenAdmin = token;
    document.getElementById("logoutAdminWrapper").style.display = "block";
  } else {
    window.modoAdmin = false;
  }

  // Inicializar variables de stock por talle
  window.stockPorTalleData = {};
  
  // Delegaci√≥n de eventos para actualizaci√≥n de stock por talle
  document.addEventListener('change', (e) => {
    if (e.target.id && e.target.id.startsWith('talle_')) {
      const idProducto = e.target.id.replace('talle_', '');
      const talleSeleccionado = e.target.value;
      if (talleSeleccionado) {
        actualizarStockPorTalle(idProducto, talleSeleccionado);
      }
    }
  });

  // Bot√≥n Subcategor√≠as
  const btnSubcategorias = document.getElementById("btnSubcategorias");
  if (btnSubcategorias) {
    btnSubcategorias.addEventListener("click", () => {
      const panelSub = document.getElementById("panelSubcategorias");
      if (panelSub) panelSub.classList.remove("oculta");
      setTimeout(ajustarPosicionesPaneles, 0);
    });
  }

  // Delegaci√≥n de eventos para botones de grupo din√°micos
  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("btn-grupo")) {
      setTimeout(ajustarPosicionesPaneles, 0);
    }

    const carritoDiv = document.getElementById("carrito");
    const toggleBtn = document.getElementById("toggleCarrito");
    if (carritoDiv && toggleBtn) {
      const visible = carritoDiv.style.display === "block";
      const clicFueraCarrito = !carritoDiv.contains(e.target) && !toggleBtn.contains(e.target);
      if (visible && clicFueraCarrito) {
        carritoDiv.style.display = "none";
      }
    }

    const panelGrupos = document.getElementById("panelGrupos");
    const panelSub = document.getElementById("panelSubcategorias");
    if (panelGrupos && panelSub) {
      const esClickDentroGrupos = panelGrupos.contains(e.target);
      const esClickDentroSub = panelSub.contains(e.target);
      const esBotonGrupo = e.target.classList.contains("btn-grupo");
      const esBotonNavegacion = !!e.target.closest(".barra-navegacion");

      if (!esClickDentroGrupos && !esClickDentroSub && !esBotonGrupo && !esBotonNavegacion) {
        panelGrupos.classList.add("oculta");
        panelSub.classList.add("oculta");
      }
    }
  });

  // üëâ Ordenar por precio
  const ordenSelect = document.getElementById("ordenPrecio");
  if (ordenSelect) {
    ordenSelect.addEventListener("change", (e) => {
      const valor = e.target.value; // "asc" o "desc"

      const grupoActivoBtn = document.querySelector(".btn-grupo.active");
      const grupoActivo = grupoActivoBtn ? grupoActivoBtn.textContent.trim() : null;

      const subActivoBtn = document.querySelector(".btn-subgrupo.active");
      const subActivo = subActivoBtn ? subActivoBtn.textContent.trim() : null;

      let productosFiltrados = window.todosLosProductos;

      if (grupoActivo) {
        productosFiltrados = productosFiltrados.filter(
          p => p.grupo?.toLowerCase() === grupoActivo.toLowerCase()
        );
      }
      if (subActivo) {
        productosFiltrados = productosFiltrados.filter(
          p => p.subgrupo?.toLowerCase() === subActivo.toLowerCase()
        );
      }

      productosFiltrados.sort((a, b) => {
        const pa = parseFloat(a.precio) || 0;
        const pb = parseFloat(b.precio) || 0;
        return valor === "asc" ? pa - pb : pb - pa;
      });

      const cont = document.getElementById("productos");
      if (!cont) return;

      cont.innerHTML = "";
      productosFiltrados.forEach((p) => {
        const card = renderProducto(p);
        cont.appendChild(card);
        setTimeout(() => card.classList.remove("fade-reorder"), 50);
      });
    });
  }

  // üëâ Mostrar card de admin y bot√≥n Mercado Pago si corresponde
  if (window.modoAdmin) {
    const adminCard = document.getElementById("adminCard");
    if (adminCard) adminCard.classList.remove("d-none");

    const btnConfigMP = document.getElementById("configurarMP");
    if (btnConfigMP) {
      btnConfigMP.classList.remove("d-none");
    }
  }

  // üëâ Inicializar Mercado Pago din√°micamente
  async function initMercadoPago() {
    try {
      const resp = await fetch(`${URL_BACKEND}/api/mp_public_key?email=${encodeURIComponent(email)}`);
      const data = await resp.json();

      if (data.public_key) {
        window.mp = new MercadoPago(data.public_key, { locale: 'es-AR' });
        const pagarBtn = document.getElementById('btn_pagar');
        if (pagarBtn) pagarBtn.disabled = false;
      } else {
        const pagarBtn = document.getElementById('btn_pagar');
        if (pagarBtn) pagarBtn.disabled = true;
      }
    } catch (err) {
      const pagarBtn = document.getElementById('btn_pagar');
      if (pagarBtn) pagarBtn.disabled = true;
    }
  }

  initMercadoPago();

  // üëâ Funci√≥n de pago limpia con integraci√≥n de orden_id
  async function pagarConMercadoPago() {
    try {
      if (!carrito.length) {
        return;
      }

      const response = await fetch("https://mpagina.onrender.com/pagar", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          carrito,
          email_vendedor: email,
          url_retorno: window.location.href
        })
      });

      let data = null;
      const contentType = response.headers.get("content-type") || "";

      if (response.ok && contentType.includes("application/json")) {
        try {
          data = await response.json();
        } catch {
          return;
        }
      } else {
        return;
      }

      if (data && data.preference_id && window.mp) {
        // üëá Guardar el external_reference para usarlo en el formulario cliente
        window.orden_id = data.external_reference;

        window.mp.checkout({
          preference: { id: data.preference_id },
          autoOpen: true
        });
      } else if (data && data.init_point) {
        // üëá Guardar tambi√©n aqu√≠
        window.orden_id = data.external_reference;
        window.location.href = data.init_point;
      }
    } catch {
      return;
    }
  }

  const pagarBtn = document.getElementById('btn_pagar');
  if (pagarBtn) {
    pagarBtn.addEventListener("click", pagarConMercadoPago);
  }

  // üëâ VERIFICAR SI VENIMOS DE CONFIGURACI√ìN EXITOSA DE MERCADO PAGO
  // Esto debe ejecutarse despu√©s de todo lo anterior
  setTimeout(() => {
    const urlParams = new URLSearchParams(window.location.search);
    
    if (urlParams.get('mp_configurado') === 'true') {
        const emailVendedor = urlParams.get('email');
        console.log('‚úÖ Mercado Pago configurado exitosamente para:', emailVendedor);
        
        // Mostrar mensaje de √©xito
        alert('‚úÖ ¬°Mercado Pago configurado exitosamente! Ahora puedes recibir pagos.');
        
        // Limpiar la URL (quitar par√°metros)
        const nuevaURL = window.location.pathname + '?email=' + encodeURIComponent(emailVendedor);
        window.history.replaceState({}, document.title, nuevaURL);
        
        // Recargar para actualizar el estado (mostrar bot√≥n de pago, etc.)
        setTimeout(() => {
            location.reload();
        }, 1500);
    }
    
    if (urlParams.get('mp_error') === '1') {
        alert('‚ùå Hubo un error al configurar Mercado Pago. Por favor, intenta nuevamente.');
        
        // Limpiar la URL
        const nuevaURL = window.location.pathname;
        window.history.replaceState({}, document.title, nuevaURL);
    }
  }, 100);
});
    
// üëâ Nueva funci√≥n ordenarGrupo
function ordenarGrupo(valor) {
  console.log("üîÑ ordenarGrupo llamada con:", valor);

  const cont = document.getElementById("productos");
  if (!cont) return;

  const grupoCanon = window.currentGrupo;
  const subCanon = window.currentSub;

  let productosFiltrados = window.todosLosProductos.filter(p =>
    String(p.grupo || "").toLowerCase() === grupoCanon.toLowerCase() &&
    String(p.subgrupo || "").toLowerCase() === subCanon.toLowerCase()
  );

  productosFiltrados.sort((a, b) => {
    const pa = Number(a.precio) || 0;
    const pb = Number(b.precio) || 0;
    return valor === "asc" ? pa - pb : pb - pa;
  });
  console.log("üìä Productos ordenados:", valor, productosFiltrados);

  cont.innerHTML = "";

  const grupoDiv = document.createElement("div");
  grupoDiv.className = "grupo-section";
  grupoDiv.innerHTML = `<h3>${grupoCanon}</h3>`;

  const subDiv = document.createElement("div");
  subDiv.className = "subgrupo-bloque";
  subDiv.innerHTML = `<h4>${subCanon}</h4>`;

  productosFiltrados.forEach(p => {
    const card = renderProducto(p);
    subDiv.appendChild(card);

    requestAnimationFrame(() => card.classList.add("show"));
    setTimeout(() => card.classList.remove("fade-reorder"), 50);

    console.log("üõí Card insertada en subgrupo:", p.nombre);
  });

  grupoDiv.appendChild(subDiv);
  cont.appendChild(grupoDiv);
  console.log("‚úÖ Bloque renderizado en ordenarGrupo, hijos finales:", cont.children.length);
}

window.ordenarGrupo = ordenarGrupo;

// Bot√≥n Productos (SOLO cierra los paneles)
const btnProductos = document.getElementById('btnProductos');
if (btnProductos) {
  btnProductos.addEventListener('click', (e) => {
    e.stopPropagation(); // Evita conflictos con otros clicks

    // Solo ocultamos los paneles
    document.getElementById('panelGrupos').classList.add('oculta');
    document.getElementById('panelSubcategorias').classList.add('oculta');
    
    // Eliminamos mostrarTodos() y scrollTo() para no alterar la vista
  });
}
   
</script>
<script type="module">
const usarFirestore = false;
const email = "ferj.9622@gmail.com";

setTimeout(() => {
  if (!window.todosLosProductos || window.todosLosProductos.length === 0) return;

  const primerGrupo = [...new Set(window.todosLosProductos.map(p => p.grupo))][0];
  if (!primerGrupo) return;

  const primerGrupoId = primerGrupo.trim().toLowerCase().replace(/\s+/g, '_');
  const primerGrupoDiv = document.getElementById('grupo_' + primerGrupoId);
  if (primerGrupoDiv) primerGrupoDiv.classList.add('active');

  const subgrupos = [...new Set(window.todosLosProductos
    .filter(p => p.grupo === primerGrupo)
    .map(p => p.subgrupo))];

  // Normalizar: si no hay subgrupo, usar General_{grupo}
  let primerSubgrupoNombre = subgrupos[0]?.trim();
  if (!primerSubgrupoNombre) {
    primerSubgrupoNombre = `General_${primerGrupo}`;
  }

  if (primerGrupoId && primerSubgrupoNombre) {
    filtrarSubcategoria(primerGrupo, primerSubgrupoNombre);
  }
}, 100);

document.getElementById("inputFoto").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  try {
    const blobOptimizado = await optimizarImagen(file);
    window.fotoOptimizada = blobOptimizado;

    const urlPreview = URL.createObjectURL(blobOptimizado);
    const imgPreview = document.getElementById("previewFoto");
    imgPreview.src = urlPreview;
    imgPreview.classList.remove("d-none");

    // Mostrar bot√≥n quitar foto
    document.getElementById("btnQuitarFoto").classList.remove("d-none");

    console.log("üëÅÔ∏è Preview inmediato mostrado");
  } catch (err) {
    console.error("üí• Error al optimizar imagen:", err);
    alert("‚ùå No se pudo optimizar la imagen");
  }
});

document.getElementById("btnQuitarFoto").addEventListener("click", () => {
  // Limpiar input y preview
  document.getElementById("inputFoto").value = "";
  const imgPreview = document.getElementById("previewFoto");
  imgPreview.src = "";
  imgPreview.classList.add("d-none");

  // Ocultar bot√≥n y limpiar referencia global
  document.getElementById("btnQuitarFoto").classList.add("d-none");
  window.fotoOptimizada = null;

  console.log("üóëÔ∏è Foto eliminada");
});
   
</script>
<script>
// FRONTEND - Enviar TODO en una sola llamada
async function procesarPago() {
    // 1. Obtener datos del formulario
    const nombre = document.querySelector('input[name="nombre"]').value;
    const apellido = document.querySelector('input[name="apellido"]').value;
    const email = document.querySelector('input[name="email"]').value;
    const telefono = document.querySelector('input[name="telefono"]').value;
    
    // 2. Preparar payload
    const payload = {
        email_vendedor: window.email_vendedor, // Aseg√∫rate de tener esto
        numero_vendedor: window.numero_vendedor,
        items: window.carritoActual,
        cliente_nombre: `${nombre} ${apellido}`.trim(),
        cliente_email: email,
        cliente_telefono: telefono,
        orden_id: window.orden_id // Si tienes preorden, si no lo quitas
    };
    
    console.log("[PAGAR] Enviando:", payload);
    
    try {
        const response = await fetch('/pagar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert("Error: " + data.error);
        } else if (data.init_point) {
            // Guardar el external_reference en localStorage para referencia
            localStorage.setItem('ultima_orden', data.external_reference);
            // Redirigir a Mercado Pago
            window.location.href = data.init_point;
        }
        
    } catch (error) {
        console.error("Error:", error);
        alert("Error al procesar el pago");
    }
}
</script>  
<script src="https://sdk.mercadopago.com/js/v2"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>  
<script>
  const PUBLIC_KEY = "";
  let mp = null;

  if (PUBLIC_KEY) {
    mp = new MercadoPago(PUBLIC_KEY, { locale: 'es-AR' });
  }

  const pagarBtn = document.getElementById('btn_pagar');
  if (pagarBtn && !PUBLIC_KEY) {
    pagarBtn.disabled = true;
  }

  console.log("PUBLIC_KEY:", PUBLIC_KEY);
</script>
</body>
</html>
